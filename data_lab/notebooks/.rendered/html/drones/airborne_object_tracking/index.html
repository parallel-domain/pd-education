<!DOCTYPE html>

<html lang="en">
<head></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="Drone-scenarios-with-other-flying-agents-for-Airborne-Object-Tracking-(AOT)">Drone scenarios with other flying agents for Airborne Object Tracking (AOT)<a class="anchor-link" href="#Drone-scenarios-with-other-flying-agents-for-Airborne-Object-Tracking-(AOT)">¶</a></h1><p><img alt="AOT Scene" src="./resources/images/aot_scene.jpg"/></p>
<p>In this notebook, we will expand on a drone scenario by adding another flying object to the scene, which can produce useful training data for Airborne Object Tracking (AOT). To do this, we will create one <code>CustomSimulationAgentBehaviour</code> for the ego drone which creates a straight line path between point A and point B, with added translation and rotation noise for realism. Then, we will create a second <code>CustomSimulationAgentBehaviour</code> for the other flying object, having it</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Notebook-Outline">Notebook Outline<a class="anchor-link" href="#Notebook-Outline">¶</a></h2><ol>
<li><a href="#imports_and_setup">Imports and Setup</a><ol>
<li><a href="#import_dependencies">Import Dependencies</a></li>
<li><a href="#setup_datalab">Setting up Data Lab session</a></li>
</ol>
</li>
<li><a href="#custom_behaviours">Write Custom Simulation Behaviours</a><ol>
<li><a href="#custom_behaviour_straight_flight">Custom Simulation Behaviour: Straight line flight from point A to point B</a></li>
<li><a href="#custom_behaviour_tangential_flight">Custom Simulation Behaviour: Tangential flight relative to a reference pose</a></li>
</ol>
</li>
<li><a href="#sensor_rig">Configure Sensor Rig</a></li>
<li><a href="#scenario_gen">Create Scenario</a><ol>
<li><a href="#scenario_init">Initialize Scenario</a></li>
<li><a href="#scenario_environment">Set environment: location, weather, and time of day</a></li>
<li><a href="#scenario_set_start_target_poses">Set ego start and target poses</a></li>
<li><a href="#scenario_place_ego_drone">Place ego drone in the world using a custom simulation agent</a></li>
<li><a href="#scenario_place_airborne_object">Place an airborne object into our field of view</a></li>
<li><a href="#scenario_preview">Preview Scenario</a></li>
</ol>
</li>
<li><a href="#mini_batch">Render and Save Mini Batch</a></li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="1.-Imports-and-Setup-">1. Imports and Setup <a class="anchor" id="imports_and_setup"></a><a class="anchor-link" href="#1.-Imports-and-Setup-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Import-Dependencies-">Import Dependencies <a class="anchor" id="import_dependencies"></a><a class="anchor-link" href="#Import-Dependencies-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">opensimplex</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">pd.data_lab.context</span> <span class="kn">import</span> <span class="n">setup_datalab</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.render_instance</span> <span class="kn">import</span> <span class="n">RenderInstance</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.sim_instance</span> <span class="kn">import</span> <span class="n">SimulationInstance</span>
<span class="kn">from</span> <span class="nn">pd.internal.proto.keystone.generated.wrapper.pd_sensor_pb2</span> <span class="kn">import</span> <span class="n">DistortionParams</span><span class="p">,</span> <span class="n">NoiseParams</span>

<span class="kn">import</span> <span class="nn">paralleldomain.data_lab</span> <span class="k">as</span> <span class="nn">data_lab</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab</span> <span class="kn">import</span> <span class="n">preview_scenario</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.annotation</span> <span class="kn">import</span> <span class="n">InstanceSegmentation2D</span><span class="p">,</span> <span class="n">Depth</span><span class="p">,</span> <span class="n">SemanticSegmentation2D</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.logging</span> <span class="kn">import</span> <span class="n">setup_loggers</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.transformation</span> <span class="kn">import</span> <span class="n">Transformation</span>

<span class="n">setup_loggers</span><span class="p">(</span><span class="n">logger_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"__main__"</span><span class="p">,</span> <span class="s2">"paralleldomain"</span><span class="p">])</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"pd"</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Setting-up-Data-Lab-session-">Setting up Data Lab session <a class="anchor" id="setup_datalab"></a><a class="anchor-link" href="#Setting-up-Data-Lab-session-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">DATA_LAB_VERSION</span> <span class="o">=</span> <span class="s2">"v2.3.0-beta"</span>
<span class="n">LOCATION_NAME</span> <span class="o">=</span> <span class="s2">"SJ_680MissionPass"</span>
<span class="n">INSTANCE_NAME</span> <span class="o">=</span> <span class="s2">"gjwqhnnv"</span>
<span class="n">setup_datalab</span><span class="p">(</span><span class="n">DATA_LAB_VERSION</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="2.-Write-Custom-Simulation-Behaviours-">2. Write Custom Simulation Behaviours <a class="anchor" id="custom_behaviours"></a><a class="anchor-link" href="#2.-Write-Custom-Simulation-Behaviours-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Custom-Simulation-Behaviour:-Straight-line-flight-from-point-A-to-point-B-">Custom Simulation Behaviour: Straight line flight from point A to point B <a class="anchor" id="custom_behaviour_straight_flight"></a><a class="anchor-link" href="#Custom-Simulation-Behaviour:-Straight-line-flight-from-point-A-to-point-B-">¶</a></h3><p>We use Parallel Domain SDK's base classes to define a custom simulation behavior. In this case, we accept a <code>start_pose</code> and <code>target_pose</code>, defining where an agent starts and should end up. By specifying a <code>flight_time</code>, we can then calculate the velocity the agent needs to have to make it from <code>start_pose</code> to <code>target_pose</code> within <code>flight_time</code> seconds.</p>
<p>To simulate real world recording conditions, we also add some rotational and translational noise to each pose, leveraging simplex noise. As a result, the camera recordings will have a slight "shake" from frame to frame.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StraightLineFlightBehavior</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">target_pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">flight_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_pose</span> <span class="o">=</span> <span class="n">start_pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_pose</span> <span class="o">=</span> <span class="n">target_pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flight_time</span> <span class="o">=</span> <span class="n">flight_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_flight_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">flight_completion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transformation</span><span class="p">:</span>
        <span class="n">translation_max_noise</span> <span class="o">=</span> <span class="mf">0.005</span>  <span class="c1"># in m</span>
        <span class="n">rotation_max_noise</span> <span class="o">=</span> <span class="mf">0.0025</span>  <span class="c1"># in quaternion coefficient scalar</span>
        <span class="n">translation_noise</span> <span class="o">=</span> <span class="n">translation_max_noise</span> <span class="o">*</span> <span class="n">opensimplex</span><span class="o">.</span><span class="n">noise2</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">25</span> <span class="o">*</span> <span class="n">flight_completion</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">rotation_noise</span> <span class="o">=</span> <span class="n">rotation_max_noise</span> <span class="o">*</span> <span class="n">opensimplex</span><span class="o">.</span><span class="n">noise2</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">25</span> <span class="o">*</span> <span class="n">flight_completion</span><span class="p">)</span>

        <span class="n">pose_with_noise</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span>
            <span class="n">quaternion</span><span class="o">=</span><span class="p">[</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rotation_noise</span><span class="p">,</span>  <span class="c1"># add random noise to movement along world X-axis</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">rotation_noise</span><span class="p">,</span>  <span class="c1"># add random noise to movement along world Y-axis</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rotation_noise</span><span class="p">,</span>  <span class="c1"># add random noise to movement along world Z-axis</span>
            <span class="p">],</span>
            <span class="n">translation</span><span class="o">=</span><span class="p">[</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation_noise</span><span class="p">,</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation_noise</span><span class="p">,</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation_noise</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">pose_with_noise</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">sim_time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">current_time</span>  <span class="c1"># set first frame as start time even if not exactly 0.0 seconds</span>

        <span class="c1"># calculate ratio of flight profile completion [0.0, 1.0]</span>
        <span class="n">flight_completion</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flight_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>

        <span class="n">interpolated_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">tf0</span><span class="o">=</span><span class="n">start_pose</span><span class="p">,</span> <span class="n">tf1</span><span class="o">=</span><span class="n">target_pose</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">flight_completion</span><span class="p">)</span>

        <span class="n">interpolated_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_flight_noise</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">interpolated_pose</span><span class="p">,</span> <span class="n">flight_completion</span><span class="o">=</span><span class="n">flight_completion</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using interpolated pose: </span><span class="si">{</span><span class="n">interpolated_pose</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">interpolated_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"StraightLineFlightBehavior"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StraightLineFlightBehavior</span><span class="p">(</span>
            <span class="n">start_pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_pose</span><span class="p">,</span> <span class="n">target_pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_pose</span><span class="p">,</span> <span class="n">flight_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_flight_time</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Custom-Simulation-Behavior:-Tangential-flight-relative-to-a-reference-pose-">Custom Simulation Behavior: Tangential flight relative to a reference pose <a class="anchor" id="custom_behaviour_tangential_flight"></a><a class="anchor-link" href="#Custom-Simulation-Behavior:-Tangential-flight-relative-to-a-reference-pose-">¶</a></h3><p>This flight behavior places an agent relative to a <code>reference_pose</code> by using the <code>translation_offset</code>. When no <code>tangential_offset</code> is provided by the user, the agent targets the <code>reference_pose</code> in its movement. If <code>tangential_offset</code> is set to a value larger than 0, then the agent will target a point by that value in front of the <code>reference_pose</code>. This allows to control agents to fly-by the <code>reference_pose</code> in different angles.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TangentialFlightBehavior</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">reference_pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span>  <span class="c1"># the object that should be targeted in this tangential flight</span>
            <span class="n">translation_offset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
            <span class="n">tangential_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">velocity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>  <span class="c1"># in m/s</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_pose</span> <span class="o">=</span> <span class="n">reference_pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_translation_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">translation_offset</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tangential_offset</span> <span class="o">=</span> <span class="n">tangential_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_velocity</span> <span class="o">=</span> <span class="n">velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">tangential_offset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># random.choice([data_lab.coordinate_system.left, data_lab.coordinate_system.right]) * self._tangential_offset</span>
                <span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">forward</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tangential_offset</span>
        <span class="p">)</span>
        <span class="n">reference_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_pose</span> <span class="o">@</span> <span class="n">tangential_offset</span>

        <span class="n">start_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_pose</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translation_offset</span>

        <span class="n">direction_vector</span> <span class="o">=</span> <span class="n">reference_position</span> <span class="o">-</span> <span class="n">start_position</span>
        <span class="n">forward_vector</span> <span class="o">=</span> <span class="n">direction_vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction_vector</span><span class="p">)</span>

        <span class="n">left_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">up</span><span class="p">,</span> <span class="n">forward_vector</span><span class="p">)</span>
        <span class="n">left_vector</span> <span class="o">=</span> <span class="n">left_vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">left_vector</span><span class="p">)</span>

        <span class="n">up_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">forward_vector</span><span class="p">,</span> <span class="n">left_vector</span><span class="p">)</span>
        <span class="n">up_vector</span> <span class="o">=</span> <span class="n">up_vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">up_vector</span><span class="p">)</span>

        <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">tf</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">left_vector</span>  <span class="c1"># Right</span>
        <span class="n">tf</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">forward_vector</span>  <span class="c1"># Front</span>
        <span class="n">tf</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">up_vector</span>  <span class="c1"># Up</span>
        <span class="n">tf</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_position</span>

        <span class="n">start_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_transformation_matrix</span><span class="p">(</span><span class="n">mat</span><span class="o">=</span><span class="n">tf</span><span class="p">,</span> <span class="n">approximate_orthogonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Tangential pose: </span><span class="si">{</span><span class="n">start_pose</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">start_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">previous_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_transformation_matrix</span><span class="p">(</span><span class="n">mat</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span> <span class="n">approximate_orthogonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">offset_to_previous_position</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">forward</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_velocity</span> <span class="o">*</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">time_since_last_frame</span>
        <span class="p">)</span>
        <span class="n">next_position</span> <span class="o">=</span> <span class="n">previous_pose</span> <span class="o">@</span> <span class="n">offset_to_previous_position</span>
        <span class="n">next_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span><span class="n">quaternion</span><span class="o">=</span><span class="n">previous_pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">next_position</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Tangential pose: </span><span class="si">{</span><span class="n">next_pose</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">next_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TangentialFlightBehavior"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TangentialFlightBehavior</span><span class="p">(</span>
            <span class="n">reference_pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reference_pose</span><span class="p">,</span>
            <span class="n">translation_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_translation_offset</span><span class="p">,</span>
            <span class="n">tangential_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tangential_offset</span><span class="p">,</span>
            <span class="n">velocity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_velocity</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="3.-Configure-Sensor-Rig-">3. Configure Sensor Rig <a class="anchor" id="sensor_rig"></a><a class="anchor-link" href="#3.-Configure-Sensor-Rig-">¶</a></h2><p>We use a low resolution, grayscale camera sensor with slight radial and tangential lens distortion. In addition, we set an <code>iso_level</code> of <code>200</code> to recreate real noise levels we see with our real world camera sensor.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sensor_rig</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">SensorRig</span><span class="p">()</span><span class="o">.</span><span class="n">add_camera</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Front"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1080</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">1080</span><span class="p">,</span>
    <span class="n">grayscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">field_of_view_degrees</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
    <span class="n">distortion_params</span><span class="o">=</span><span class="n">DistortionParams</span><span class="p">(</span>
        <span class="n">fx</span><span class="o">=</span><span class="mf">1662.76</span><span class="p">,</span>
        <span class="n">fy</span><span class="o">=</span><span class="mf">1662.76</span><span class="p">,</span>
        <span class="n">cx</span><span class="o">=</span><span class="mf">960.0</span><span class="p">,</span>
        <span class="n">cy</span><span class="o">=</span><span class="mf">540.0</span><span class="p">,</span>
        <span class="n">k1</span><span class="o">=-</span><span class="mf">0.35</span><span class="p">,</span>
        <span class="n">k2</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
        <span class="n">k3</span><span class="o">=-</span><span class="mf">0.002</span><span class="p">,</span>
        <span class="n">k4</span><span class="o">=</span><span class="mf">0.0006</span><span class="p">,</span>
        <span class="n">k5</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">k6</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">p1</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">p2</span><span class="o">=-</span><span class="mf">0.0002</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">noise_params</span><span class="o">=</span><span class="n">NoiseParams</span><span class="p">(</span><span class="n">enable_gauss_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_poisson_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_denoise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iso_level</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">pose</span><span class="o">=</span><span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
        <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">annotation_types</span><span class="o">=</span><span class="p">[</span><span class="n">SemanticSegmentation2D</span><span class="p">,</span> <span class="n">InstanceSegmentation2D</span><span class="p">,</span> <span class="n">Depth</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="4.-Create-scenario-">4. Create scenario <a class="anchor" id="scenario_gen"></a><a class="anchor-link" href="#4.-Create-scenario-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Initialize-Scenario-">Initialize Scenario <a class="anchor" id="scenario_init"></a><a class="anchor-link" href="#Initialize-Scenario-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">Scenario</span><span class="p">(</span><span class="n">sensor_rig</span><span class="o">=</span><span class="n">sensor_rig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Set-environment:-location,-weather,-and-time-of-day-">Set environment: location, weather, and time of day <a class="anchor" id="scenario_environment"></a><a class="anchor-link" href="#Set-environment:-location,-weather,-and-time-of-day-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">LOCATION_NAME</span><span class="p">))</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">time_of_day</span><span class="o">.</span><span class="n">set_category_weight</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">TimeOfDays</span><span class="o">.</span><span class="n">Day</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">clouds</span><span class="o">.</span><span class="n">set_constant_value</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">fog</span><span class="o">.</span><span class="n">set_constant_value</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Set-ego-start-and-target-poses-">Set ego start and target poses <a class="anchor" id="scenario_set_start_target_poses"></a><a class="anchor-link" href="#Set-ego-start-and-target-poses-">¶</a></h3><p>These map positions have been chosen for SJ_680MissionPass using our <a href="https://app.paralleldomain.com/explore">Map Explorer</a></p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># SJ_680MissionPass</span>
<span class="n">start_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
    <span class="n">translation</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">580.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">530.0</span><span class="p">,</span> <span class="mf">450.0</span><span class="p">],</span> <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">target_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
    <span class="n">translation</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">480.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">430.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">],</span> <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">90.0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Place-ego-drone-in-the-world-using-a-custom-simulation-agent-">Place ego drone in the world using a custom simulation agent <a class="anchor" id="scenario_place_ego_drone"></a><a class="anchor-link" href="#Place-ego-drone-in-the-world-using-a-custom-simulation-agent-">¶</a></h3><p>Use an empty asset name so we don't see anything flying in the air obstructing cameras. Attach our custom <code>StraightLineFlightBehavior</code> from above to fly from a start position to a target position in a linear fashion. Remove <code>lock_to_ground</code> constraint so we can freely move in the world.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">flight_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># in seconds</span>

<span class="n">scenario</span><span class="o">.</span><span class="n">add_ego</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_ego_vehicle</span><span class="p">(</span><span class="n">sensor_rig</span><span class="o">=</span><span class="n">sensor_rig</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">StraightLineFlightBehavior</span><span class="p">(</span><span class="n">start_pose</span><span class="o">=</span><span class="n">start_pose</span><span class="p">,</span> <span class="n">target_pose</span><span class="o">=</span><span class="n">target_pose</span><span class="p">,</span> <span class="n">flight_time</span><span class="o">=</span><span class="n">flight_time</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[9]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x1c1c1e762b0&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Place-an-airborne-object-into-our-field-of-view-">Place an airborne object into our field of view <a class="anchor" id="scenario_place_airborne_object"></a><a class="anchor-link" href="#Place-an-airborne-object-into-our-field-of-view-">¶</a></h3><p>Create a custom agent that we place relative to our ego agent by specifying a <code>translation_offset</code>. In addition, we give it a large <code>tangential_offset</code> towards us, so we keep a safe distance. We also give it a <code>velocity</code> of 100 m/s to simulate a smaller plane flying through the area.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [10]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
        <span class="n">asset_name</span><span class="o">=</span><span class="s2">"SM_Airplane_RegionalJet_01"</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">TangentialFlightBehavior</span><span class="p">(</span>
            <span class="n">reference_pose</span><span class="o">=</span><span class="n">start_pose</span><span class="p">,</span>
            <span class="n">translation_offset</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">tangential_offset</span><span class="o">=</span><span class="mf">500.0</span><span class="p">,</span>
            <span class="n">velocity</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[10]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x1c1c1e762b0&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Preview-Scenario-">Preview Scenario <a class="anchor" id="scenario_preview"></a><a class="anchor-link" href="#Preview-Scenario-">¶</a></h3><p>Include Instance Segmentation and Depth annotation to allow easy identification of airborne objects and to simulate stereo camera output</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">preview_scenario</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">annotations_to_show</span><span class="o">=</span><span class="p">[</span><span class="n">SemanticSegmentation2D</span><span class="p">,</span> <span class="n">InstanceSegmentation2D</span><span class="p">,</span> <span class="n">Depth</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[11]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div data-rrd="1" id="iuIdsx_rrd" style="display: none;"></div>
<div id="iuIdsx_error" style="display: none;"><p>Timed out waiting for https://app.rerun.io/commit/9cf3033 to load.</p>
<p>Consider using <code>rr.start_web_viewer_server()</code></p></div>
<script>
            iuIdsx_timeout = setTimeout(() => {
                document.getElementById("iuIdsx_error").style.display = 'block';
            }, 2000);

            window.addEventListener("message", function(rrd) {
                return async function iuIdsx_onIframeReady(event) {
                    var iframe = document.getElementById("iuIdsx_iframe");
                    if (event.source === iframe.contentWindow) {
                        clearTimeout(iuIdsx_timeout);
                        document.getElementById("iuIdsx_error").style.display = 'none';
                        iframe.style.display = 'inline';
                        window.removeEventListener("message", iuIdsx_onIframeReady);
                        iframe.contentWindow.postMessage((await rrd), "*");
                    }
                }
            }(async function() {
                await new Promise(r => setTimeout(r, 0));
                var div = document.getElementById("iuIdsx_rrd");
                var base64Data = div.dataset.rrd;
                var intermediate = atob(base64Data);
                var buff = new Uint8Array(intermediate.length);
                for (var i = 0; i < intermediate.length; i++) {
                    buff[i] = intermediate.charCodeAt(i);
                }
                return buff;
            }()));
        </script>
<iframe allowfullscreen="" frameborder="0" height="712" id="iuIdsx_iframe" src="https://app.rerun.io/commit/9cf3033?url=web_event://&amp;persist=0" style="display: none;" width="950"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="5.-Render-and-Save-a-Mini-Batch-">5. Render and Save a Mini Batch <a class="anchor" id="mini_batch"></a><a class="anchor-link" href="#5.-Render-and-Save-a-Mini-Batch-">¶</a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">OUTPUT_DATASET_PATH</span> <span class="o">=</span> <span class="s2">"./aot_output"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [14]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">create_mini_batch</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">number_of_scenes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_capture_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">start_skip_frames</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">format_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset_output_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">,</span>
        <span class="n">encode_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">pipeline_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy_all_available_sensors_and_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_env</span><span class="o">=</span><span class="s2">"thread"</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 0 sensor frames [00:00, ? sensor frames/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-25 14:05:04</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 12 sensor frames [01:13,  6.13s/ sensor frames]
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
