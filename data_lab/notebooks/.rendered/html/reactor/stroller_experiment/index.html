<!DOCTYPE html>

<html lang="en">
<head></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="Reactor-Stroller-Experiment">Reactor Stroller Experiment<a class="anchor-link" href="#Reactor-Stroller-Experiment">¶</a></h1><p>Now it is time for a more advanced use of Reactor. This time we will use map information to determine sidewalk points, place a stroller on on that is visible to the ego, and place a pedestrian next to this stroller for realistic scene context. We will then see a comparative performance improvement of a semantic segmentation network (DeepLabV3) on the stroller class when trained on frames generated with Data Lab vs the same model trained on the nuImages dataset.</p>
<p><img alt="Example of stroller scene" src="./resources/images/reactor_strollers.jpg"/></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Notebook-Outline">Notebook Outline<a class="anchor-link" href="#Notebook-Outline">¶</a></h2><ol>
<li><a href="#imports_and_setup">Imports and Setup</a><ol>
<li><a href="#import_dependencies">Import Dependencies</a></li>
<li><a href="#setup_datalab">Setup Data Lab</a></li>
</ol>
</li>
<li><a href="#functions">Define Helper Functions</a></li>
<li><a href="#custom_behaviours">Create Custom Simulation Agent Behaviours</a><ol>
<li><a href="#custom_behaviour_proxy">Stroller Proxy Object Behaviour</a></li>
<li><a href="#custom_behaviour_pusher">Stroller Pusher Behaviour</a></li>
</ol>
</li>
<li><a href="#test_scenario">Generate a Scenario to Test Behaviours</a><ol>
<li><a href="#test_scenario_init">Build Empty Base Scenario</a></li>
<li><a href="#test_scenario_proxy">Add the Proxy Object</a></li>
<li><a href="#test_scenario_w_ped">Place the Pedestrian next to the Proxy Object</a></li>
</ol>
</li>
<li><a href="#full_scenario">Generate a Full Scenario with Other Agents</a><ol>
<li><a href="#full_scenario_init">Build Base Scenario</a></li>
<li><a href="#full_scenario_stroller_w_pusher">Add Stroller Primitive and Pusher</a></li>
<li><a href="#full_scenario_reactor_params">Define Parameters for Controlling Reactor Object Replacement</a></li>
</ol>
</li>
<li><a href="#mini_batch">Create a Mini Batch of Strollers Generated by Reactor</a><ol>
<li><a href="#mini_batch_save">Render and Save Mini Batch to Disk</a></li>
<li><a href="#mini_batch_load">Load Mini Batch with PD-SDK</a></li>
</ol>
</li>
<li><a href="#semseg_experiment">Experiment: Training a Semantic Segmentation Model</a></li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="1.-Imports-and-Setup-">1. Imports and Setup <a class="anchor" id="imports_and_setup"></a><a class="anchor-link" href="#1.-Imports-and-Setup-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Import-Dependencies-">Import Dependencies <a class="anchor" id="import_dependencies"></a><a class="anchor-link" href="#Import-Dependencies-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">pd.state</span>
<span class="kn">from</span> <span class="nn">pd.data_lab</span> <span class="kn">import</span> <span class="n">SimState</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.context</span> <span class="kn">import</span> <span class="n">setup_datalab</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.render_instance</span> <span class="kn">import</span> <span class="n">RenderInstance</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.sim_instance</span> <span class="kn">import</span> <span class="n">SimulationInstance</span>
<span class="kn">from</span> <span class="nn">pd.internal.assets.asset_registry</span> <span class="kn">import</span> <span class="n">DataCharacter</span>
<span class="kn">from</span> <span class="nn">pd.sim</span> <span class="kn">import</span> <span class="n">Raycast</span>
<span class="kn">from</span> <span class="nn">pd.state</span> <span class="kn">import</span> <span class="n">Pose6D</span>

<span class="kn">import</span> <span class="nn">paralleldomain.data_lab</span> <span class="k">as</span> <span class="nn">data_lab</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab</span> <span class="kn">import</span> <span class="n">CustomSimulationAgent</span><span class="p">,</span> <span class="n">CustomSimulationAgentBehaviour</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.config.reactor</span> <span class="kn">import</span> <span class="n">ReactorObject</span><span class="p">,</span> <span class="n">ReactorConfig</span>
<span class="kn">from</span> <span class="nn">paralleldomain.decoding.dgp.decoder</span> <span class="kn">import</span> <span class="n">DGPDatasetDecoder</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.annotation</span> <span class="kn">import</span> <span class="n">SemanticSegmentation2D</span><span class="p">,</span> <span class="n">InstanceSegmentation2D</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.logging</span> <span class="kn">import</span> <span class="n">setup_loggers</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.transformation</span> <span class="kn">import</span> <span class="n">Transformation</span>
<span class="kn">from</span> <span class="nn">paralleldomain.visualization.model_visualization</span> <span class="kn">import</span> <span class="n">show_scene</span>

<span class="kn">from</span> <span class="nn">pd_education.data_lab.notebook_utils</span> <span class="kn">import</span> <span class="n">FOV</span><span class="p">,</span> <span class="n">build_empty_scenario</span><span class="p">,</span> <span class="n">build_demo_scenario</span>

<span class="n">setup_loggers</span><span class="p">(</span><span class="n">logger_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"__main__"</span><span class="p">,</span> <span class="s2">"paralleldomain"</span><span class="p">])</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"pd"</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Setup-Data-Lab-">Setup Data Lab <a class="anchor" id="setup_datalab"></a><a class="anchor-link" href="#Setup-Data-Lab-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">DATA_LAB_VERSION</span> <span class="o">=</span> <span class="s2">"v2.3.0-beta"</span>
<span class="n">LOCATION_NAME</span> <span class="o">=</span> <span class="s2">"SF_6thAndMission_medium"</span>
<span class="n">INSTANCE_NAME</span> <span class="o">=</span> <span class="s2">"wermvnea"</span>
<span class="c1"># This asset will be used as the replacement object for the Reactor prompt</span>
<span class="n">PROXY_OBJECT</span> <span class="o">=</span> <span class="s2">"SM_primitive_stroller_01"</span>
<span class="n">FoV</span> <span class="o">=</span> <span class="n">FOV</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">setup_datalab</span><span class="p">(</span><span class="n">DATA_LAB_VERSION</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="2.-Define-Helper-Functions-">2. Define Helper Functions <a class="anchor" id="functions"></a><a class="anchor-link" href="#2.-Define-Helper-Functions-">¶</a></h2><p>We can query the DataCharacter table in our asset registry to get the names of our character assets. We'll need to filter out the asset names with the <code>ani_</code> prefix, as these designate our animals. We'll also filter out the children, since they shouldn't be pushing the stroller, along with construction workers, police officers, and medical workers. We will also make a helper function for determining the angle between two 3D vectors.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">random_stroller_pusher_asset_name</span><span class="p">(</span><span class="n">random_state</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">):</span>
    <span class="n">pedestrian_assets</span> <span class="o">=</span> <span class="n">DataCharacter</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">DataCharacter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">DataCharacter</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"ani_"</span><span class="p">))</span>
    <span class="n">normal_adults</span> <span class="o">=</span> <span class="n">pedestrian_assets</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">DataCharacter</span><span class="o">.</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">DataCharacter</span><span class="o">.</span><span class="n">construction_worker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">DataCharacter</span><span class="o">.</span><span class="n">police_officer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">DataCharacter</span><span class="o">.</span><span class="n">medical_worker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">random_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">na</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">normal_adults</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">get_angle</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># cosine of the angle</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="3.-Create-Custom-Simulation-Agent-Behaviours-">3. Create Custom Simulation Agent Behaviours <a class="anchor" id="custom_behaviours"></a><a class="anchor-link" href="#3.-Create-Custom-Simulation-Agent-Behaviours-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Stroller-Proxy-Object-Behaviour-">Stroller Proxy Object Behaviour <a class="anchor" id="custom_behaviour_proxy"></a><a class="anchor-link" href="#Stroller-Proxy-Object-Behaviour-">¶</a></h3><p>Creating this behaviour will allow us to place our proxy object on the sidewalk (within the field of view of the camera). We can do this by querying all sidewalk points on the map, and radonmly selecting from the filtered set which falls in the frustum of the camera and is within a desired range of distance from the ego.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StrollerPuppetMaster</span><span class="p">(</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Behaviour for randomly moving the proxy/stroller asset."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">FoV</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">FoV_divisor</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ego_distance_thrs</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="n">num_retries</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidewalk_points</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FoV_divisor</span> <span class="o">=</span> <span class="n">FoV_divisor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ego_distance_thrs</span> <span class="o">=</span> <span class="n">ego_distance_thrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_retries</span> <span class="o">=</span> <span class="n">num_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FoV</span> <span class="o">=</span> <span class="n">FoV</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">collect_sidewalk_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""The asset should be placed on the sidewalk or a crosswalk. Collect relevant points on the map."""</span>
        <span class="k">for</span> <span class="n">lane_segment_id</span><span class="p">,</span> <span class="n">lane_segment</span> <span class="ow">in</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">lane_segments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lane_type</span> <span class="o">=</span> <span class="n">lane_segment</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="n">lane_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
                <span class="c1"># 6: LaneType.CROSSWALK</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lane_segment</span><span class="o">.</span><span class="n">reference_line</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sidewalk_points</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sidewalk_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sidewalk_points</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">is_point_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">"""Given a point, check if it is within the FoV and at a reasonable distance from the ego sensor."""</span>
        <span class="c1"># get ego translation and velocity</span>
        <span class="n">ego_pose</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">ego_agent</span><span class="o">.</span><span class="n">step_agent</span><span class="o">.</span><span class="n">pose</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ego_pose</span><span class="p">,</span> <span class="n">Pose6D</span><span class="p">):</span>
            <span class="n">ego_translation</span> <span class="o">=</span> <span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ego_translation</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ego_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">ego_forward</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">ego_agent</span><span class="o">.</span><span class="n">step_agent</span><span class="o">.</span><span class="n">velocity</span>

        <span class="n">translation_from_ego</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ego_translation</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">translation_from_ego</span><span class="p">,</span> <span class="n">ego_forward</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="n">angle</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FoV</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">FoV_divisor</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ego_distance_thrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">translation_from_ego</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ego_distance_thrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">generate_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">):</span>
        <span class="n">valid_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidewalk_points</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_point_visible</span><span class="p">(</span><span class="n">sim_state</span><span class="p">,</span> <span class="n">p</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_points</span><span class="p">)</span>
            <span class="n">euler_angles</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_transformation_matrix</span><span class="p">(</span>
                <span class="n">sim_state</span><span class="o">.</span><span class="n">ego_agent</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span> <span class="n">approximate_orthogonal</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_euler_angles</span><span class="p">(</span><span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">)</span>

            <span class="n">euler_angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">euler_angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">270</span><span class="p">)</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
                <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">euler_angles</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">pose</span><span class="o">.</span><span class="n">transformation_matrix</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">"CustomSimulationAgent"</span><span class="p">,</span> <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="s2">"CustomSimulationAgent"</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_sidewalk_points</span><span class="p">(</span><span class="n">sim_state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_retries</span><span class="p">):</span>
            <span class="n">new_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_pose</span><span class="p">(</span><span class="n">sim_state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_pose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">new_pose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_pose</span> <span class="o">=</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">ego_pose</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_pose</span><span class="p">,</span> <span class="n">Transformation</span><span class="p">):</span>
                <span class="n">new_pose</span> <span class="o">=</span> <span class="n">new_pose</span><span class="o">.</span><span class="n">transformation_matrix</span>
            <span class="n">new_pose</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">new_pose</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"StrollerPuppetMaster"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StrollerPuppetMaster</span><span class="p">(</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">FoV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FoV</span><span class="p">,</span>
            <span class="n">FoV_divisor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FoV_divisor</span><span class="p">,</span>
            <span class="n">ego_distance_thrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ego_distance_thrs</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Stroller-Pusher-Behaviour-">Stroller Pusher Behaviour <a class="anchor" id="custom_behaviour_pusher"></a><a class="anchor-link" href="#Stroller-Pusher-Behaviour-">¶</a></h3><p>Creates the behaviour of the pedestrian next to the stroller. We'll use the same rotation of the proxy, and use the translation relative to ego to add some distance and place the stroller pusher behind the proxy from the ego's perspective.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StrollerPusherPuppetMaster</span><span class="p">(</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Behaviour responsible for moving the pedestrian agent who is "pushing" or standing nearby the proxy/stroller."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">distance_from_proxy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">proxy_asset_name</span><span class="o">=</span><span class="s2">"SM_primitive_stroller_01"</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_from_proxy</span> <span class="o">=</span> <span class="n">distance_from_proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_asset_name</span> <span class="o">=</span> <span class="n">proxy_asset_name</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_new_pose_from_ego_proxy_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Collect the proxy's position and the ego's position.</span>
<span class="sd">        Place the pedestrian behind the proxy (from the ego sensor's point of view), and make them face the camera).</span>
<span class="sd">        """</span>
        <span class="n">proxy_objects</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">a</span><span class="o">.</span><span class="n">step_agent</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sim_state</span><span class="o">.</span><span class="n">current_agents</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">step_agent</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ModelAgent</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">step_agent</span><span class="o">.</span><span class="n">asset_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_asset_name</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">proxy_objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">proxy_to_world</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">pose</span>
        <span class="n">proxy_pos_world</span> <span class="o">=</span> <span class="n">proxy_to_world</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">ego_to_world</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_transformation_matrix</span><span class="p">(</span><span class="n">sim_state</span><span class="o">.</span><span class="n">ego_agent</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span> <span class="n">approximate_orthogonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">proxy_pos_ego</span> <span class="o">=</span> <span class="n">ego_to_world</span><span class="o">.</span><span class="n">inverse</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">proxy_pos_world</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">proxy_pos_ego</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">proxy_pos_ego</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_from_proxy</span>
        <span class="n">agent_pos_ego</span> <span class="o">=</span> <span class="n">proxy_pos_ego</span> <span class="o">+</span> <span class="n">offset</span>

        <span class="n">agent_pos_world</span> <span class="o">=</span> <span class="n">ego_to_world</span> <span class="o">@</span> <span class="n">agent_pos_ego</span>

        <span class="n">euler_angles</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_transformation_matrix</span><span class="p">(</span><span class="n">proxy_to_world</span><span class="p">)</span><span class="o">.</span><span class="n">as_euler_angles</span><span class="p">(</span>
            <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span>
        <span class="p">)</span>  <span class="c1"># same angle as the proxy/stroller</span>

        <span class="n">pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
            <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">euler_angles</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">agent_pos_world</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pose</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sim_state</span><span class="p">:</span> <span class="n">SimState</span><span class="p">,</span>
            <span class="n">agent</span><span class="p">:</span> <span class="n">CustomSimulationAgent</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">new_pose</span><span class="p">:</span> <span class="n">Transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_pose_from_ego_proxy_translation</span><span class="p">(</span><span class="n">sim_state</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">new_pose</span><span class="o">.</span><span class="n">transformation_matrix</span>
        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">new_pose</span><span class="o">.</span><span class="n">translation</span> <span class="o">+</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">up</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">raycast</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Raycast</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">start_pos</span><span class="p">),</span> <span class="n">direction</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">down</span><span class="p">),</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">10</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">step_agent</span><span class="o">.</span><span class="n">asset_name</span> <span class="o">=</span> <span class="n">random_stroller_pusher_asset_name</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"StrollerPusherPuppetMaster"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StrollerPusherPuppetMaster</span><span class="p">(</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">distance_from_proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_from_proxy</span><span class="p">,</span>
            <span class="n">proxy_asset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_asset_name</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="4.-Generate-a-Scenario-to-Test-Behaviours-">4. Generate a Scenario to Test Behaviours <a class="anchor" id="test_scenario"></a><a class="anchor-link" href="#4.-Generate-a-Scenario-to-Test-Behaviours-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Build-Empty-Base-Scenario-">Build Empty Base Scenario <a class="anchor" id="test_scenario_init"></a><a class="anchor-link" href="#Build-Empty-Base-Scenario-">¶</a></h3><p>We can use this helper function to generate an empty scenario to test our custom agent behaviour on.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span> <span class="o">=</span> <span class="n">build_empty_scenario</span><span class="p">(</span><span class="n">location_name</span><span class="o">=</span><span class="n">LOCATION_NAME</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Using random seed 60 on SF_6thAndMission_medium
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Add-the-Proxy-Object-">Add the Proxy Object <a class="anchor" id="test_scenario_proxy"></a><a class="anchor-link" href="#Add-the-Proxy-Object-">¶</a></h3><p>Here, we are using the stroller primitive proxy object as a target object for Reactor.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">asset_name</span><span class="o">=</span><span class="n">PROXY_OBJECT</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">StrollerPuppetMaster</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">FoV</span><span class="o">=</span><span class="p">(</span><span class="n">FoV</span><span class="o">-</span><span class="mi">20</span><span class="p">),</span> <span class="n">ego_distance_thrs</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[7]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x1b3276464f0&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h4 id="Inspect-the-placement-of-the-proxy-object-using-the-custom-behavior-">Inspect the placement of the proxy object using the custom behavior <a class="anchor" id="test_scenario_proxy_inspect"></a><a class="anchor-link" href="#Inspect-the-placement-of-the-proxy-object-using-the-custom-behavior-">¶</a></h4><p><img alt="Proxy object test" src="./resources/images/reactor_strollers_empty.jpg"/>
<em>Example output of empty scene with proxy placed</em></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Place-the-Pedestrian-next-to-the-Proxy-Object-">Place the Pedestrian next to the Proxy Object <a class="anchor" id="test_scenario_w_ped"></a><a class="anchor-link" href="#Place-the-Pedestrian-next-to-the-Proxy-Object-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_pedestrian</span><span class="p">(</span><span class="n">asset_name</span><span class="o">=</span><span class="s2">"char_cindy_002"</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">StrollerPusherPuppetMaster</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">proxy_asset_name</span><span class="o">=</span><span class="n">PROXY_OBJECT</span><span class="p">,</span>
                                   <span class="n">distance_from_proxy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[8]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x1b3276464f0&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h4 id="Inspect-the-placement-of-the-proxy-object-and-the-pedestrian-using-new-behavior-">Inspect the placement of the proxy object and the pedestrian using new behavior <a class="anchor" id="test_scenario_w_ped_inspect"></a><a class="anchor-link" href="#Inspect-the-placement-of-the-proxy-object-and-the-pedestrian-using-new-behavior-">¶</a></h4><p><img alt="Proxy with pedestrian" src="./resources/images/reactor_strollers_w_ped.jpg"/>
<em>Example output of proxy placed with pedestrian</em></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="5.-Generate-a-Full-Scenario-with-Other-Agents-">5. Generate a Full Scenario with Other Agents <a class="anchor" id="full_scenario"></a><a class="anchor-link" href="#5.-Generate-a-Full-Scenario-with-Other-Agents-">¶</a></h2><p>We can now place the other agents into the scenario, and inspect the result. We will use our helper function to build a base scenario, then add our stroller and its pusher.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Build-Base-Scenario-">Build Base Scenario <a class="anchor" id="full_scenario_init"></a><a class="anchor-link" href="#Build-Base-Scenario-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span> <span class="o">=</span> <span class="n">build_demo_scenario</span><span class="p">(</span><span class="n">location_name</span><span class="o">=</span><span class="n">LOCATION_NAME</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="p">[</span><span class="n">SemanticSegmentation2D</span><span class="p">,</span> <span class="n">InstanceSegmentation2D</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Using random seed 60 on SF_6thAndMission_medium
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Add-Stroller-Primitive-and-Pusher-">Add Stroller Primitive and Pusher <a class="anchor" id="full_scenario_stroller_w_pusher"></a><a class="anchor-link" href="#Add-Stroller-Primitive-and-Pusher-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span><span class="n">asset_name</span><span class="o">=</span><span class="n">PROXY_OBJECT</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">StrollerPuppetMaster</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">FoV</span><span class="o">=</span><span class="p">(</span><span class="n">FoV</span><span class="o">-</span><span class="mi">20</span><span class="p">),</span> <span class="n">ego_distance_thrs</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_pedestrian</span><span class="p">(</span><span class="n">asset_name</span><span class="o">=</span><span class="s2">"char_cindy_002"</span><span class="p">,</span> <span class="n">lock_to_ground</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
        <span class="n">StrollerPusherPuppetMaster</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">proxy_asset_name</span><span class="o">=</span><span class="n">PROXY_OBJECT</span><span class="p">,</span>
                                   <span class="n">distance_from_proxy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h4 id="Inspecting-the-scene-with-other-agents-placed">Inspecting the scene with other agents placed<a class="anchor-link" href="#Inspecting-the-scene-with-other-agents-placed">¶</a></h4><p><img alt="Example of full scene" src="./resources/images/reactor_strollers_w_agents.jpg"/>
<em>Example of scene with all agents placed</em></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Define-Parameters-for-Controlling-Reactor-Object-Replacement">Define Parameters for Controlling Reactor Object Replacement<a class="anchor" id="full_scenario_reactor_params"></a><a class="anchor-link" href="#Define-Parameters-for-Controlling-Reactor-Object-Replacement">¶</a></h3><p>For a review, here are the definitions of the parameters:</p>
<ul>
<li><code>use_color_matching</code> - lets Reactor know that we'd like to match the color characteristics of the surrounding frame (generally best left to True)</li>
<li><code>inference_resolution</code> - image crop will be scaled to this resolution before the image generation process (512 works well)</li>
<li><code>clip_score_threshold</code> - will determine the minimum clip score for an accepted result. Higher values may yield less, more realistic results (18-26 is a good range)</li>
</ul>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [26]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">reactor_object</span> <span class="o">=</span> <span class="n">ReactorObject</span><span class="p">(</span><span class="n">prompts</span><span class="o">=</span><span class="p">[</span><span class="s2">"stroller"</span><span class="p">],</span> <span class="n">asset_name</span><span class="o">=</span><span class="n">PROXY_OBJECT</span><span class="p">,</span> <span class="n">new_class_id</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">reactor_config</span> <span class="o">=</span> <span class="n">ReactorConfig</span><span class="p">(</span><span class="n">reactor_object</span><span class="o">=</span><span class="n">reactor_object</span><span class="p">)</span>
<span class="n">reactor_config</span><span class="o">.</span><span class="n">use_color_matching</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">reactor_config</span><span class="o">.</span><span class="n">inference_resolution</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">reactor_config</span><span class="o">.</span><span class="n">clip_score_threshold</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="6.-Create-a-Mini-Batch-of-Strollers-Generated-by-Reactor-">6. Create a Mini Batch of Strollers Generated by Reactor <a class="anchor" id="mini_batch"></a><a class="anchor-link" href="#6.-Create-a-Mini-Batch-of-Strollers-Generated-by-Reactor-">¶</a></h2><p>Now we will take our scenario, generate a couple of scenes with it, and write these out into a dataset which we can load with the PD-SDK</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Render-and-Save-Mini-Batch-to-Disk-">Render and Save Mini Batch to Disk <a class="anchor" id="mini_batch_save"></a><a class="anchor-link" href="#Render-and-Save-Mini-Batch-to-Disk-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [33]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">OUTPUT_DATASET_PATH</span> <span class="o">=</span> <span class="s2">"./reactor_stroller_output"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [28]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">create_mini_batch</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">number_of_scenes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_capture_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">start_skip_frames</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">reactor_config</span><span class="o">=</span><span class="n">reactor_config</span><span class="p">,</span>
    <span class="n">use_cached_reactor_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">format_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset_output_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">,</span>
        <span class="n">encode_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">pipeline_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy_all_available_sensors_and_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_env</span><span class="o">=</span><span class="s2">"thread"</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 0 sensor frames [00:00, ? sensor frames/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-25 19:47:50</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
<span class="ansi-green-fg">2023-07-25 19:48:50</span> <span class="ansi-blue-fg">paralleldomain.data_lab[create_reactor_frame_stream]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Reactor: creating auxiliary dataset.
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre></pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-25 19:48:50</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 4 sensor frames [00:50, 12.65s/ sensor frames]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-25 19:49:41</span> <span class="ansi-blue-fg">paralleldomain.data_lab[create_reactor_frame_stream]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Reactor: creating reactor dataset.
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>
Encoding Progress: 4 sensor frames [02:46, 41.64s/ sensor frames]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Load-Mini-Batch-with-PD-SDK-">Load Mini Batch with PD-SDK <a class="anchor" id="mini_batch_load"></a><a class="anchor-link" href="#Load-Mini-Batch-with-PD-SDK-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [34]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">DGPDatasetDecoder</span><span class="p">(</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_scene</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">scene_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [35]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">show_scene</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[35]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div data-rrd="1" id="GDOGeX_rrd" style="display: none;"></div>
<div id="GDOGeX_error" style="display: none;"><p>Timed out waiting for https://app.rerun.io/commit/9cf3033 to load.</p>
<p>Consider using <code>rr.start_web_viewer_server()</code></p></div>
<script>
            GDOGeX_timeout = setTimeout(() => {
                document.getElementById("GDOGeX_error").style.display = 'block';
            }, 2000);

            window.addEventListener("message", function(rrd) {
                return async function GDOGeX_onIframeReady(event) {
                    var iframe = document.getElementById("GDOGeX_iframe");
                    if (event.source === iframe.contentWindow) {
                        clearTimeout(GDOGeX_timeout);
                        document.getElementById("GDOGeX_error").style.display = 'none';
                        iframe.style.display = 'inline';
                        window.removeEventListener("message", GDOGeX_onIframeReady);
                        iframe.contentWindow.postMessage((await rrd), "*");
                    }
                }
            }(async function() {
                await new Promise(r => setTimeout(r, 0));
                var div = document.getElementById("GDOGeX_rrd");
                var base64Data = div.dataset.rrd;
                var intermediate = atob(base64Data);
                var buff = new Uint8Array(intermediate.length);
                for (var i = 0; i < intermediate.length; i++) {
                    buff[i] = intermediate.charCodeAt(i);
                }
                return buff;
            }()));
        </script>
<iframe allowfullscreen="" frameborder="0" height="712" id="GDOGeX_iframe" src="https://app.rerun.io/commit/9cf3033?url=web_event://&amp;persist=0" style="display: none;" width="950"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="7.-Experiment:-Training-a-Semantic-Segmentation-Model-">7. Experiment: Training a Semantic Segmentation Model <a class="anchor" id="semseg_experiment"></a><a class="anchor-link" href="#7.-Experiment:-Training-a-Semantic-Segmentation-Model-">¶</a></h2><p>To show the viability of using the data generated with Reactor we tested it on real data, more specifically the nuImages dataset.
As strollers are heavily undersampled in real world data we first created a targeted subset from nuImages:</p>
<ul>
<li>nuImages training set: 5000 images, 114 images with strollers (Singapore only)</li>
<li>nuImages validation set: 500 images, 212 images with strollers (Boston only)</li>
<li>PD Reactor Dataset: 5000 images, 5000 images with strollers</li>
</ul>
<p>We trained an off-the-shelve deeplabV3 model for semantic segmentation. Hyperparameters are the same for all training sets.</p>
<p><img alt="Stroller training results" src="./resources/images/reactor_strollers_plot_combined.jpg"/></p>
<p><strong>Using Reactor we are able to train a model that significantly and consistently outperforms the model trained on real world examples.</strong></p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
