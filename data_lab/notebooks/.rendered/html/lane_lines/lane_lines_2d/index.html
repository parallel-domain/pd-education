<!DOCTYPE html>

<html lang="en">
<head></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a34ea4fb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="Lane-Lines">Lane Lines<a class="anchor-link" href="#Lane-Lines">¶</a></h1><p><img alt="Example Lane Line Annotation" src="./resources/images/lane_lines.jpg"/></p>
<p>Lane line detection is a foundational task in autonomous driving. Often, we want these lines represented as polylines or points in either 3D or 2D. Our map objects make it possible to locate the adjacent lines around the ego and express them in various ways. To do this, we find the Lane ID the ego is currently occupying by finding the map's lane segment with the shortest distance to the current ego pose. This information is all we need to query any number of neighboring lanes and pull their edge information. Here, we will get an array of 3D points and project them onto the 2D images for a clear visual example of this process.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c98d7764-0299-4478-8741-f6ba9e8ac11c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Notebook-Outline">Notebook Outline<a class="anchor-link" href="#Notebook-Outline">¶</a></h2><ol>
<li><a href="#imports_and_setup">Imports and Setup</a><ol>
<li><a href="#import_dependencies">Import Dependencies</a></li>
<li><a href="#setup_datalab">Setup Data Lab</a></li>
</ol>
</li>
<li><a href="#annotation_functions">Create functions that will assist with lane line annotation plotting</a><ul>
<li><a href="#function_ego_lane_id">Find Ego Lane ID</a></li>
<li><a href="#function_neighboring_lanes">Find Neighboring Lane IDs</a></li>
<li><a href="#function_2d_line_annotations">Get 2D Lane Line Annotations</a></li>
<li><a href="#function_plot_lane_lines">Plot Lane Line Annotations</a></li>
</ul>
</li>
<li><a href="#sensor_rig">Set up an RGB-only Camera Rig</a></li>
<li><a href="#scenario1_suburban">Suburban Example</a><ol>
<li><a href="#scenario1_init">Set up a Suburban Scenario</a></li>
<li><a href="#scenario1_preview">Preview the Suburban Scenario</a></li>
<li><a href="#scenario1_mini_batch_save">Render and Save a Suburban Mini Batch</a></li>
<li><a href="#scenario1_mini_batch_load">Load the Suburban Mini Batch using PD-SDK</a></li>
<li><a href="#scenario1_ego_lane_plot">Plot ego lane</a></li>
<li><a href="#scenario1_adjacent_lanes_plot">Plot ego lane and adjacent lanes</a></li>
</ol>
</li>
<li><a href="#scenario2_highway">Highway Example</a><ol>
<li><a href="#scenario2_init">Set up a Highway Scenario</a></li>
<li><a href="#scenario2_preview">Preview the Highway Scenario</a></li>
<li><a href="#scenario2_mini_batch_save">Render and Save a Highway Mini Batch</a></li>
<li><a href="#scenario2_mini_batch_load">Load the Highway Mini Batch using PD-SDK</a></li>
<li><a href="#scenario2_lane_lines_plot">Plot Lane Lines</a></li>
</ol>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6830c00a-c7c6-4502-9d0d-60bc9221a0ca">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="1.-Imports-and-Setup-">1. Imports and Setup <a class="anchor" id="imports_and_setup"></a><a class="anchor-link" href="#1.-Imports-and-Setup-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ea10f83a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Import-Dependencies-">Import Dependencies <a class="anchor" id="import_dependencies"></a><a class="anchor-link" href="#Import-Dependencies-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2beb4031">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>

<span class="kn">from</span> <span class="nn">pd.data_lab.config.distribution</span> <span class="kn">import</span> <span class="n">CenterSpreadConfig</span><span class="p">,</span> <span class="n">EnumDistribution</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.context</span> <span class="kn">import</span> <span class="n">setup_datalab</span><span class="p">,</span> <span class="n">load_map</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.render_instance</span> <span class="kn">import</span> <span class="n">RenderInstance</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.sim_instance</span> <span class="kn">import</span> <span class="n">SimulationInstance</span>

<span class="kn">import</span> <span class="nn">paralleldomain.data_lab</span> <span class="k">as</span> <span class="nn">data_lab</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.config.map</span> <span class="kn">import</span> <span class="n">MapQuery</span><span class="p">,</span> <span class="n">UniversalMap</span><span class="p">,</span> <span class="n">LaneSegment</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.generators.ego_agent</span> <span class="kn">import</span> <span class="n">AgentType</span><span class="p">,</span> <span class="n">EgoAgentGeneratorParameters</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.generators.peripherals</span> <span class="kn">import</span> <span class="n">VehiclePeripheral</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.generators.position_request</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LaneSpawnPolicy</span><span class="p">,</span>
    <span class="n">LocationRelativePositionRequest</span><span class="p">,</span>
    <span class="n">PositionRequest</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.generators.spawn_data</span> <span class="kn">import</span> <span class="n">VehicleSpawnData</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.generators.traffic</span> <span class="kn">import</span> <span class="n">TrafficGeneratorParameters</span>
<span class="kn">from</span> <span class="nn">paralleldomain.decoding.dgp.decoder</span> <span class="kn">import</span> <span class="n">DGPDatasetDecoder</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.sensor</span> <span class="kn">import</span> <span class="n">CameraSensorFrame</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.geometry.bounding_box_2d</span> <span class="kn">import</span> <span class="n">BoundingBox2DGeometry</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.coordinate_system</span> <span class="kn">import</span> <span class="n">CoordinateSystem</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.logging</span> <span class="kn">import</span> <span class="n">setup_loggers</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.transformation</span> <span class="kn">import</span> <span class="n">Transformation</span>

<span class="kn">from</span> <span class="nn">pd_education.data_lab.notebook_utils</span> <span class="kn">import</span> <span class="n">build_demo_scenario</span>

<span class="n">setup_loggers</span><span class="p">(</span><span class="n">logger_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"__main__"</span><span class="p">,</span> <span class="s2">"paralleldomain"</span><span class="p">,</span> <span class="s2">"pd"</span><span class="p">])</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"pd"</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3e88720e">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Setup-Data-Lab-">Setup Data Lab <a class="anchor" id="setup_datalab"></a><a class="anchor-link" href="#Setup-Data-Lab-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bcff6e14">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">INSTANCE_NAME</span> <span class="o">=</span> <span class="s2">"slqridfs"</span>
<span class="n">DATA_LAB_VERSION</span> <span class="o">=</span> <span class="s2">"v2.3.0-beta"</span>
<span class="n">setup_datalab</span><span class="p">(</span><span class="n">DATA_LAB_VERSION</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fd656fab">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="2.-Create-functions-that-will-assist-with-lane-line-annotation-plotting-">2. Create functions that will assist with lane line annotation plotting <a class="anchor" id="annotation_functions"></a><a class="anchor-link" href="#2.-Create-functions-that-will-assist-with-lane-line-annotation-plotting-">¶</a></h2><p>To generate our lane line annotations, we will need to perform some querying on the map to find our ego's lane using pose information contained in each <code>CameraSensorFrame</code>. Once we know the lane ID of the ego vehicle, we can find the lane edges, represent them as 3D polylines, then project these 3D lines onto the image using the <code>project_points_from_3d</code> method. From there, we can visualize these lines on the camera image using Pillow's <code>ImageDraw</code>.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b3f4e186-9c46-451d-bfc6-d9befab6bb65">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Find-Ego-Lane-ID-">Find Ego Lane ID <a class="anchor" id="function_ego_lane_id"></a><a class="anchor-link" href="#Find-Ego-Lane-ID-">¶</a></h3><p>Function to find the Ego's Lane ID based on its current map position.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f56478a0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">find_ego_lane_id</span><span class="p">(</span><span class="nb">map</span><span class="p">:</span> <span class="n">UniversalMap</span><span class="p">,</span> <span class="n">camera_frame</span><span class="p">:</span> <span class="n">CameraSensorFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">ego_pose</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">get_base_change_from_to</span><span class="p">(</span><span class="s2">"FLU"</span><span class="p">,</span> <span class="s2">"RFU"</span><span class="p">)</span> <span class="o">@</span> <span class="n">camera_frame</span><span class="o">.</span><span class="n">ego_to_world</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">BoundingBox2DGeometry</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">map_query</span> <span class="o">=</span> <span class="n">MapQuery</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>

    <span class="n">lanes_near</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lane</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_lane_segments_within_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">"overlap"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">LaneSegment</span><span class="o">.</span><span class="n">LaneType</span><span class="o">.</span><span class="n">DRIVABLE</span>
    <span class="p">]</span>

    <span class="n">lines_near</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">reference_line</span><span class="p">]</span><span class="o">.</span><span class="n">as_polyline</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes_near</span><span class="p">]</span>

    <span class="n">dist_to_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_near</span><span class="p">]</span>

    <span class="n">current_lane</span> <span class="o">=</span> <span class="n">lanes_near</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist_to_lines</span><span class="p">)]</span>

    <span class="n">lanes_to_draw</span> <span class="o">=</span> <span class="p">[</span><span class="n">current_lane</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_lane</span><span class="o">.</span><span class="n">successors</span>

    <span class="k">return</span> <span class="n">lanes_to_draw</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d22aaa8d-f3c2-46d6-9e5c-8910281fd7e8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Find-Neighboring-Lane-IDs-">Find Neighboring Lane IDs <a class="anchor" id="function_neighboring_lanes"></a><a class="anchor-link" href="#Find-Neighboring-Lane-IDs-">¶</a></h3><p>This function allows us to recursively find neighboring lanes for a given lane ID</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=57fc0868">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">find_adjacent_lanes</span><span class="p">(</span><span class="n">found_lanes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">current_lane_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_adjacent_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">map</span><span class="p">:</span> <span class="n">UniversalMap</span><span class="p">):</span>
    <span class="n">current_lane</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">lane_segments</span><span class="p">[</span><span class="n">current_lane_id</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">num_adjacent_layers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lane_on_left</span> <span class="o">=</span> <span class="n">current_lane</span><span class="o">.</span><span class="n">left_neighbor</span>
        <span class="k">if</span> <span class="n">lane_on_left</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lane_on_left</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_lanes</span><span class="p">:</span>
            <span class="n">found_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_on_left</span><span class="p">)</span>
            <span class="n">found_lanes</span> <span class="o">=</span> <span class="n">find_adjacent_lanes</span><span class="p">(</span>
                <span class="n">found_lanes</span><span class="o">=</span><span class="n">found_lanes</span><span class="p">,</span>
                <span class="n">current_lane_id</span><span class="o">=</span><span class="n">lane_on_left</span><span class="p">,</span>
                <span class="n">num_adjacent_layers</span><span class="o">=</span><span class="n">num_adjacent_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">lane_on_right</span> <span class="o">=</span> <span class="n">current_lane</span><span class="o">.</span><span class="n">right_neighbor</span>
        <span class="k">if</span> <span class="n">lane_on_right</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lane_on_right</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_lanes</span><span class="p">:</span>
            <span class="n">found_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_on_right</span><span class="p">)</span>
            <span class="n">found_lanes</span> <span class="o">=</span> <span class="n">find_adjacent_lanes</span><span class="p">(</span>
                <span class="n">found_lanes</span><span class="o">=</span><span class="n">found_lanes</span><span class="p">,</span>
                <span class="n">current_lane_id</span><span class="o">=</span><span class="n">lane_on_right</span><span class="p">,</span>
                <span class="n">num_adjacent_layers</span><span class="o">=</span><span class="n">num_adjacent_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">found_lanes</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=126d606a-01f8-4dbe-88be-8ad2bba1c99f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Get-2D-Lane-Line-Annotations-">Get 2D Lane Line Annotations <a class="anchor" id="function_2d_line_annotations"></a><a class="anchor-link" href="#Get-2D-Lane-Line-Annotations-">¶</a></h3><p>This function will project the lane segment points into 2D to annotate our frames.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fb076d2a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [24]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_2d_lane_line_annotations</span><span class="p">(</span>
    <span class="nb">map</span><span class="p">:</span> <span class="n">UniversalMap</span><span class="p">,</span>
    <span class="n">camera_frame</span><span class="p">:</span> <span class="n">CameraSensorFrame</span><span class="p">,</span>
    <span class="n">lane_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">offset_lane_lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">line_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">lane</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">lane_segments</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>

    <span class="n">left_line</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">get_base_change_from_to</span><span class="p">(</span><span class="s2">"RFU"</span><span class="p">,</span> <span class="s2">"FLU"</span><span class="p">)</span> <span class="o">@</span> <span class="nb">map</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">left_edge</span><span class="p">]</span><span class="o">.</span><span class="n">as_polyline</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">right_line</span> <span class="o">=</span> <span class="n">CoordinateSystem</span><span class="o">.</span><span class="n">get_base_change_from_to</span><span class="p">(</span><span class="s2">"RFU"</span><span class="p">,</span> <span class="s2">"FLU"</span><span class="p">)</span> <span class="o">@</span> <span class="nb">map</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">right_edge</span><span class="p">]</span><span class="o">.</span><span class="n">as_polyline</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Project into 3D image coordinates</span>
    <span class="n">right_line_image_3d</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_frame</span><span class="o">.</span><span class="n">ego_to_sensor</span> <span class="o">@</span> <span class="n">camera_frame</span><span class="o">.</span><span class="n">ego_to_world</span><span class="o">.</span><span class="n">inverse</span> <span class="o">@</span> <span class="n">right_line</span><span class="p">)</span>
    <span class="n">left_line_image_3d</span> <span class="o">=</span> <span class="p">(</span><span class="n">camera_frame</span><span class="o">.</span><span class="n">ego_to_sensor</span> <span class="o">@</span> <span class="n">camera_frame</span><span class="o">.</span><span class="n">ego_to_world</span><span class="o">.</span><span class="n">inverse</span> <span class="o">@</span> <span class="n">left_line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">offset_lane_lines</span><span class="p">:</span>
        <span class="n">lane_diffs_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">right_line_image_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">right_line_image_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])])</span>
        <span class="n">lane_diffs_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">left_line_image_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">left_line_image_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])])</span>

        <span class="n">lane_diffs_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">lane_diffs_right</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lane_diffs_right</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lane_diffs_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">line_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">lane_diffs_left</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">lane_diffs_left</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">inward_normal_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">lane_diffs_right</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lane_diffs_right</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span>
        <span class="n">inward_normal_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">lane_diffs_left</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">lane_diffs_left</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span>

        <span class="n">right_line_image_3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">inward_normal_right</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">right_line_image_3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">inward_normal_right</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">left_line_image_3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">inward_normal_left</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">left_line_image_3d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">inward_normal_left</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Use built-in function to project to 2D image coordinates</span>
    <span class="n">right_line_image_2d</span> <span class="o">=</span> <span class="n">camera_frame</span><span class="o">.</span><span class="n">project_points_from_3d</span><span class="p">(</span>
        <span class="n">points_3d</span><span class="o">=</span><span class="n">right_line_image_3d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">right_line_image_3d</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">left_line_image_2d</span> <span class="o">=</span> <span class="n">camera_frame</span><span class="o">.</span><span class="n">project_points_from_3d</span><span class="p">(</span>
        <span class="n">points_3d</span><span class="o">=</span><span class="n">left_line_image_3d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">left_line_image_3d</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">left_line_image_2d</span><span class="p">,</span> <span class="n">right_line_image_2d</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8018b7c3-2fe9-4213-9d5c-38c4ca1cf323">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Plot-Lane-Line-Annotations-">Plot Lane Line Annotations <a class="anchor" id="function_plot_lane_lines"></a><a class="anchor-link" href="#Plot-Lane-Line-Annotations-">¶</a></h3><p>Function to plot lane line annotations on a camera frame from Data Lab.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3b0c14f0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_lane_lines</span><span class="p">(</span><span class="nb">map</span><span class="p">:</span> <span class="n">UniversalMap</span><span class="p">,</span> <span class="n">camera_frame</span><span class="p">:</span> <span class="n">CameraSensorFrame</span><span class="p">,</span> <span class="n">num_adjacent_lanes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">line_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">offset_lane_lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Use built-in function to find ego lane</span>
    <span class="n">ego_lane_ids</span> <span class="o">=</span> <span class="n">find_ego_lane_id</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">camera_frame</span><span class="o">=</span><span class="n">camera_frame</span><span class="p">)</span>

    <span class="c1"># Find adjacent lane ids using built-in function</span>
    <span class="n">lanes_to_plot</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ego_lane_ids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ego_lane_id</span> <span class="ow">in</span> <span class="n">ego_lane_ids</span><span class="p">:</span>
        <span class="n">lanes_to_plot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">find_adjacent_lanes</span><span class="p">(</span><span class="n">found_lanes</span><span class="o">=</span><span class="p">[</span><span class="n">ego_lane_id</span><span class="p">],</span> <span class="n">current_lane_id</span><span class="o">=</span><span class="n">ego_lane_id</span><span class="p">,</span> <span class="n">num_adjacent_layers</span><span class="o">=</span><span class="n">num_adjacent_lanes</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">)))</span>

    <span class="c1"># Show the rendered image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">camera_frame</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">rgb</span><span class="p">)</span>

    <span class="c1"># Loop through each of the selected lanes, get the annotations and plot them the image</span>
    <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">lanes_to_plot</span><span class="p">:</span>

        <span class="n">left_line_image_2d</span><span class="p">,</span> <span class="n">right_line_image_2d</span> <span class="o">=</span> <span class="n">get_2d_lane_line_annotations</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">camera_frame</span><span class="o">=</span><span class="n">camera_frame</span><span class="p">,</span> <span class="n">lane_id</span><span class="o">=</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">offset_lane_lines</span><span class="o">=</span><span class="n">offset_lane_lines</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>

        <span class="n">img1</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">img1</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">right_line_image_2d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">right_line_image_2d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">right_line_image_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">img1</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">left_line_image_2d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">left_line_image_2d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left_line_image_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>

    <span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c3acaf53">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="3.-Set-up-an-RGB-only-camera-rig-">3. Set up an RGB-only camera rig <a class="anchor" id="sensor_rig"></a><a class="anchor-link" href="#3.-Set-up-an-RGB-only-camera-rig-">¶</a></h2><p>Since for this task we're only interested in the RGB images, we can save render time by setting the <code>annotation_types</code> to <code>None</code>.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9f30e2b8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sensor_rig</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">SensorRig</span><span class="p">(</span>
    <span class="n">sensor_configs</span><span class="o">=</span><span class="p">[</span>
        <span class="n">data_lab</span><span class="o">.</span><span class="n">SensorConfig</span><span class="o">.</span><span class="n">create_camera_sensor</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"Front"</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1920</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">540</span><span class="p">,</span>
            <span class="n">field_of_view_degrees</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
            <span class="n">pose</span><span class="o">=</span><span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
                <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">annotation_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=867a319b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="4.-Suburban-Example-">4. Suburban Example <a class="anchor" id="scenario1_suburban"></a><a class="anchor-link" href="#4.-Suburban-Example-">¶</a></h2><p>First, we will see what this looks like on one of our suburban maps, <code>A2_Kerrytown</code>.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a8d050ee">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Set-up-a-Suburban-Scenario-">Set up a Suburban Scenario <a class="anchor" id="scenario1_init"></a><a class="anchor-link" href="#Set-up-a-Suburban-Scenario-">¶</a></h3><p>We can use our helper function here to create a base scenario to test our lane line annotation functions on. To review this process, please see <a href="./1_data_lab_overview.ipynb">the first notebook</a> in this series, or step into the helper function.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=08488d7c">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">location_name</span> <span class="o">=</span> <span class="s2">"A2_Kerrytown"</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">482632</span>
<span class="n">scenario</span> <span class="o">=</span> <span class="n">build_demo_scenario</span><span class="p">(</span><span class="n">location_name</span><span class="o">=</span><span class="n">location_name</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">sensor_rig</span><span class="o">=</span><span class="n">sensor_rig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Using random seed 482632 on A2_Kerrytown
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=83d79187">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Get our map object by name</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">load_map</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">location_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=2b136aa5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Preview-the-Suburban-Scenario-">Preview the Suburban Scenario <a class="anchor" id="scenario1_preview"></a><a class="anchor-link" href="#Preview-the-Suburban-Scenario-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=14449454">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">preview_scenario</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">annotations_to_show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[11]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div data-rrd="1" id="HomshU_rrd" style="display: none;"></div>
<div id="HomshU_error" style="display: none;"><p>Timed out waiting for https://app.rerun.io/commit/9cf3033 to load.</p>
<p>Consider using <code>rr.start_web_viewer_server()</code></p></div>
<script>
            HomshU_timeout = setTimeout(() => {
                document.getElementById("HomshU_error").style.display = 'block';
            }, 2000);

            window.addEventListener("message", function(rrd) {
                return async function HomshU_onIframeReady(event) {
                    var iframe = document.getElementById("HomshU_iframe");
                    if (event.source === iframe.contentWindow) {
                        clearTimeout(HomshU_timeout);
                        document.getElementById("HomshU_error").style.display = 'none';
                        iframe.style.display = 'inline';
                        window.removeEventListener("message", HomshU_onIframeReady);
                        iframe.contentWindow.postMessage((await rrd), "*");
                    }
                }
            }(async function() {
                await new Promise(r => setTimeout(r, 0));
                var div = document.getElementById("HomshU_rrd");
                var base64Data = div.dataset.rrd;
                var intermediate = atob(base64Data);
                var buff = new Uint8Array(intermediate.length);
                for (var i = 0; i < intermediate.length; i++) {
                    buff[i] = intermediate.charCodeAt(i);
                }
                return buff;
            }()));
        </script>
<iframe allowfullscreen="" frameborder="0" height="712" id="HomshU_iframe" src="https://app.rerun.io/commit/9cf3033?url=web_event://&amp;persist=0" style="display: none;" width="950"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=06c997be">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Render-and-Save-a-Suburban-Mini-Batch-">Render and Save a Suburban Mini Batch <a class="anchor" id="scenario1_mini_batch_save"></a><a class="anchor-link" href="#Render-and-Save-a-Suburban-Mini-Batch-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a6136930">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">OUTPUT_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"./lane_lines_output/</span><span class="si">{</span><span class="n">location_name</span><span class="si">}</span><span class="s2">/seed_</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=43052be0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">create_mini_batch</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">number_of_scenes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_capture_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">start_skip_frames</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">format_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset_output_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">,</span>
        <span class="n">encode_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">pipeline_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy_all_available_sensors_and_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_env</span><span class="o">=</span><span class="s2">"thread"</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 0 sensor frames [00:00, ? sensor frames/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-25 14:28:53</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 3 sensor frames [06:52, 137.41s/ sensor frames]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=65c7ea88-a492-432c-b59d-1d106a8e01eb">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Load-the-Suburban-Mini-Batch-using-PD-SDK-">Load the Suburban Mini Batch using PD-SDK <a class="anchor" id="scenario1_mini_batch_load"></a><a class="anchor-link" href="#Load-the-Suburban-Mini-Batch-using-PD-SDK-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=99db00ba-ccc3-4260-ab9b-97fda6068f2f">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">DGPDatasetDecoder</span><span class="p">(</span><span class="n">dataset_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">cam_frame</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">camera_frames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d3615ae5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Plot-ego-lane-">Plot ego lane <a class="anchor" id="scenario1_ego_lane_plot"></a><a class="anchor-link" href="#Plot-ego-lane-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=578b944a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">plot_lane_lines</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">camera_frame</span><span class="o">=</span><span class="n">cam_frame</span><span class="p">,</span> <span class="n">num_adjacent_lanes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5b9d0f3b">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p><img alt="Ego lane output" src="./resources/images/lane_lines_2d_ego.jpg"/></p>
<p><em>Example output</em></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=813c8af5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Plot-ego-lane-and-adjacent-lanes-">Plot ego lane and adjacent lanes <a class="anchor" id="scenario1_adjacent_lanes_plot"></a><a class="anchor-link" href="#Plot-ego-lane-and-adjacent-lanes-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f50b9a22">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">plot_lane_lines</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">camera_frame</span><span class="o">=</span><span class="n">cam_frame</span><span class="p">,</span> <span class="n">num_adjacent_lanes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=e875f85a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p><img alt="Adjacent lines output" src="./resources/images/lane_lines_2d_adjacent.jpg"/></p>
<p><em>Example output</em></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=db0c98f3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="5.-Highway-Scenario-">5. Highway Scenario <a class="anchor" id="scenario2_highway"></a><a class="anchor-link" href="#5.-Highway-Scenario-">¶</a></h2><p>We'll now switch to one of our highway maps, <code>SJ_237AndGreatAmerica</code>.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0321f630">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Set-up-a-Highway-Scenario-">Set up a Highway Scenario <a class="anchor" id="scenario2_init"></a><a class="anchor-link" href="#Set-up-a-Highway-Scenario-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4758869a">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [18]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">scenario</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">Scenario</span><span class="p">(</span><span class="n">sensor_rig</span><span class="o">=</span><span class="n">sensor_rig</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="mi">844284</span>

<span class="c1"># Set weather variables and time of day</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">time_of_day</span><span class="o">.</span><span class="n">set_category_weight</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">TimeOfDays</span><span class="o">.</span><span class="n">Day</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">clouds</span><span class="o">.</span><span class="n">set_constant_value</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">rain</span><span class="o">.</span><span class="n">set_constant_value</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">fog</span><span class="o">.</span><span class="n">set_uniform_distribution</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">wetness</span><span class="o">.</span><span class="n">set_uniform_distribution</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Switch to a highway map</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"SJ_237AndGreatAmerica"</span><span class="p">))</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">load_map</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"SJ_237AndGreatAmerica"</span><span class="p">))</span>
<span class="n">map_query</span> <span class="o">=</span> <span class="n">MapQuery</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>

<span class="n">scenario</span><span class="o">.</span><span class="n">add_ego</span><span class="p">(</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">EgoAgentGeneratorParameters</span><span class="p">(</span>
        <span class="n">agent_type</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">VEHICLE</span><span class="p">,</span>
        <span class="n">position_request</span><span class="o">=</span><span class="n">PositionRequest</span><span class="p">(</span>
            <span class="n">lane_spawn_policy</span><span class="o">=</span><span class="n">LaneSpawnPolicy</span><span class="p">(</span>
                <span class="n">lane_type</span><span class="o">=</span><span class="n">EnumDistribution</span><span class="p">(</span>
                    <span class="n">probabilities</span><span class="o">=</span><span class="p">{</span><span class="s2">"Drivable"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">),</span>
                <span class="n">min_path_length</span><span class="o">=</span><span class="n">CenterSpreadConfig</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">vehicle_spawn_data</span><span class="o">=</span><span class="n">VehicleSpawnData</span><span class="p">(</span><span class="n">vehicle_peripheral</span><span class="o">=</span><span class="n">VehiclePeripheral</span><span class="p">(</span><span class="n">disable_occupants</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">TrafficGeneratorParameters</span><span class="p">(</span>
        <span class="n">spawn_probability</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">position_request</span><span class="o">=</span><span class="n">PositionRequest</span><span class="p">(</span>
            <span class="n">location_relative_position_request</span><span class="o">=</span><span class="n">LocationRelativePositionRequest</span><span class="p">(</span>
                <span class="n">agent_tags</span><span class="o">=</span><span class="p">[</span><span class="s2">"EGO"</span><span class="p">],</span>
                <span class="n">max_spawn_radius</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[18]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x1b5ac22bf40&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7c17a4c0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Preview-the-Highway-Scenario-">Preview the Highway Scenario <a class="anchor" id="scenario2_preview"></a><a class="anchor-link" href="#Preview-the-Highway-Scenario-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dff2ac44">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">preview_scenario</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">annotations_to_show</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[17]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div data-rrd="2" id="FhWEiZ_rrd" style="display: none;"></div>
<div id="FhWEiZ_error" style="display: none;"><p>Timed out waiting for https://app.rerun.io/commit/9cf3033 to load.</p>
<p>Consider using <code>rr.start_web_viewer_server()</code></p></div>
<script>
            FhWEiZ_timeout = setTimeout(() => {
                document.getElementById("FhWEiZ_error").style.display = 'block';
            }, 2000);

            window.addEventListener("message", function(rrd) {
                return async function FhWEiZ_onIframeReady(event) {
                    var iframe = document.getElementById("FhWEiZ_iframe");
                    if (event.source === iframe.contentWindow) {
                        clearTimeout(FhWEiZ_timeout);
                        document.getElementById("FhWEiZ_error").style.display = 'none';
                        iframe.style.display = 'inline';
                        window.removeEventListener("message", FhWEiZ_onIframeReady);
                        iframe.contentWindow.postMessage((await rrd), "*");
                    }
                }
            }(async function() {
                await new Promise(r => setTimeout(r, 0));
                var div = document.getElementById("FhWEiZ_rrd");
                var base64Data = div.dataset.rrd;
                var intermediate = atob(base64Data);
                var buff = new Uint8Array(intermediate.length);
                for (var i = 0; i < intermediate.length; i++) {
                    buff[i] = intermediate.charCodeAt(i);
                }
                return buff;
            }()));
        </script>
<iframe allowfullscreen="" frameborder="0" height="712" id="FhWEiZ_iframe" src="https://app.rerun.io/commit/9cf3033?url=web_event://&amp;persist=0" style="display: none;" width="950"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=af2b4f85">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Render-and-Save-a-Highway-Mini-Batch-">Render and Save a Highway Mini Batch <a class="anchor" id="scenario2_mini_batch_save"></a><a class="anchor-link" href="#Render-and-Save-a-Highway-Mini-Batch-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c473cc36">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">OUTPUT_DATASET_PATH</span> <span class="o">=</span> <span class="s2">"./lane_lines_output2"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=59d3fda0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [20]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">create_mini_batch</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">number_of_scenes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_capture_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">start_skip_frames</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">format_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset_output_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">,</span>
        <span class="n">encode_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">pipeline_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy_all_available_sensors_and_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_env</span><span class="o">=</span><span class="s2">"thread"</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 0 sensor frames [00:00, ? sensor frames/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-07-26 11:33:21</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 3 sensor frames [00:55, 18.35s/ sensor frames]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=e55969e4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Load-the-Highway-Mini-Batch-using-PD-SDK-">Load the Highway Mini Batch using PD-SDK <a class="anchor" id="scenario2_mini_batch_load"></a><a class="anchor-link" href="#Load-the-Highway-Mini-Batch-using-PD-SDK-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ecb9a3c0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">DGPDatasetDecoder</span><span class="p">(</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">cam_frame</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">camera_frames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5adc6ff0">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Plot-Lane-Lines-">Plot Lane Lines <a class="anchor" id="scenario2_lane_lines_plot"></a><a class="anchor-link" href="#Plot-Lane-Lines-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7ba27d03">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">plot_lane_lines</span><span class="p">(</span><span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span> <span class="n">camera_frame</span><span class="o">=</span><span class="n">cam_frame</span><span class="p">,</span> <span class="n">num_adjacent_lanes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=cfca0770">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p><img alt="Highway lane lines output" src="./resources/images/lane_lines.jpg"/></p>
<p><em>Example output</em></p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3e9f7808">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
