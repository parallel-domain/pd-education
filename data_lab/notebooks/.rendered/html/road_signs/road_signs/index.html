<!DOCTYPE html>

<html lang="en">
<head></head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="Road-Signs">Road Signs<a class="anchor-link" href="#Road-Signs">¶</a></h1><p><img alt="Example road signs output" src="./resources/images/road_signs.jpg"/></p>
<p>In this notebook, we will look at the use case of improving road sign classification scores by generating an abundance of training examples. Speed sign classification accuracy has never been more important, with ISA becoming mandatory for cars sold in the EU by 2024, and Parallel Domain offers sign assets that cover a wide array of European countries.</p>
<p>Building on the asset querying and custom simulation agent concepts we saw in previous notebooks, we can define functions to query our assets for street signs of a particular country and procedurally place these signs on poles in our driving scenes. We will query the assets, develop a two separate <code>CustomSimulationAgentBehaviour</code> classes, one for the signs and one for the poles, then use these to develop our first <code>CustomAtomicGenerator</code> which will procedurally place signs along road edges according to user parameters.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Notebook-Outline">Notebook Outline<a class="anchor-link" href="#Notebook-Outline">¶</a></h2><ol>
<li><a href="#imports_and_setup">Imports and Setup</a><ol>
<li><a href="#import_dependencies">Import Dependencies</a></li>
<li><a href="#setup_datalab">Setup Data Lab</a></li>
</ol>
</li>
<li><a href="#helper_functions">Define Helper Functions for Querying, Building, and Placing Traffic Signs</a><ol>
<li><a href="#functions_asset_query">Asset Querying Functions</a></li>
<li><a href="#functions_sign_generator">Helper Functions for Sign Generator</a></li>
</ol>
</li>
<li><a href="#custom_behaviours">Define Custom Simulation Behaviours for Traffic Signs and Poles</a><ol>
<li><a href="#traffic_sign_behaviour">Traffic Sign Behaviour</a></li>
<li><a href="#traffic_pole_behaviour">Traffic Pole Behaviour</a></li>
</ol>
</li>
<li><a href="#traffic_sign_generator">Create Traffic Sign Generator</a></li>
<li><a href="#scenario_gen">Create Scenario</a><ol>
<li><a href="#scenario_init">Build Base Scenario</a></li>
<li><a href="#scenario_add_signs">Add sign agents to the scene using the custom sign generator</a></li>
<li><a href="#scenario_preview_signs">Preview scenario with signs added</a></li>
</ol>
</li>
<li><a href="#mini_batch">Create a Mini Batch</a><ol>
<li><a href="#mini_batch_save">Render Mini Batch and Save to Disk</a></li>
<li><a href="#mini_batch_load">Load Mini Batch with PD-SDK</a></li>
</ol>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="1.-Imports-and-Setup-">1. Imports and Setup <a class="anchor" id="imports_and_setup"></a><a class="anchor-link" href="#1.-Imports-and-Setup-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Import-Dependencies-">Import Dependencies <a class="anchor" id="import_dependencies"></a><a class="anchor-link" href="#Import-Dependencies-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">pd.assets</span> <span class="kn">import</span> <span class="n">ObjAssets</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.config.distribution</span> <span class="kn">import</span> <span class="n">CenterSpreadConfig</span><span class="p">,</span> <span class="n">EnumDistribution</span><span class="p">,</span> <span class="n">Distribution</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.context</span> <span class="kn">import</span> <span class="n">setup_datalab</span><span class="p">,</span> <span class="n">load_map</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.render_instance</span> <span class="kn">import</span> <span class="n">RenderInstance</span>
<span class="kn">from</span> <span class="nn">pd.data_lab.sim_instance</span> <span class="kn">import</span> <span class="n">SimulationInstance</span>
<span class="kn">from</span> <span class="nn">pd.internal.assets.asset_registry</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InfoSegmentation</span><span class="p">,</span>
    <span class="n">UtilSegmentationCategoriesPanoptic</span><span class="p">,</span>
    <span class="n">ObjCountries</span><span class="p">,</span>
    <span class="n">DataSign</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pd.sim</span> <span class="kn">import</span> <span class="n">Raycast</span>

<span class="kn">import</span> <span class="nn">paralleldomain.data_lab</span> <span class="k">as</span> <span class="nn">data_lab</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab</span> <span class="kn">import</span> <span class="n">Location</span>
<span class="kn">from</span> <span class="nn">paralleldomain.data_lab.config.map</span> <span class="kn">import</span> <span class="n">MapQuery</span><span class="p">,</span> <span class="n">UniversalMap</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">LaneSegment</span>
<span class="kn">from</span> <span class="nn">paralleldomain.decoding.dgp.decoder</span> <span class="kn">import</span> <span class="n">DGPDatasetDecoder</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.annotation</span> <span class="kn">import</span> <span class="n">SemanticSegmentation2D</span><span class="p">,</span> <span class="n">InstanceSegmentation2D</span><span class="p">,</span> <span class="n">Depth</span>
<span class="kn">from</span> <span class="nn">paralleldomain.model.geometry.bounding_box_2d</span> <span class="kn">import</span> <span class="n">BoundingBox2DBaseGeometry</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.logging</span> <span class="kn">import</span> <span class="n">setup_loggers</span>
<span class="kn">from</span> <span class="nn">paralleldomain.utilities.transformation</span> <span class="kn">import</span> <span class="n">Transformation</span>

<span class="kn">from</span> <span class="nn">pd_education.data_lab.notebook_utils</span> <span class="kn">import</span> <span class="n">build_demo_scenario</span>

<span class="n">setup_loggers</span><span class="p">(</span><span class="n">logger_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"__main__"</span><span class="p">,</span> <span class="s2">"paralleldomain"</span><span class="p">,</span> <span class="s2">"pd"</span><span class="p">])</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"pd"</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Setup-Data-Lab-">Setup Data Lab <a class="anchor" id="setup_datalab"></a><a class="anchor-link" href="#Setup-Data-Lab-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># DATA_LAB_VERSION = "v2.3.0-beta"</span>
<span class="n">DATA_LAB_VERSION</span> <span class="o">=</span> <span class="s2">"v2.4.0-beta"</span>
<span class="n">LOCATION</span> <span class="o">=</span> <span class="s2">"SF_GrantAndCalifornia"</span>
<span class="n">INSTANCE_NAME</span> <span class="o">=</span> <span class="s2">"xwjwxrev"</span>
<span class="n">setup_datalab</span><span class="p">(</span><span class="n">DATA_LAB_VERSION</span><span class="p">)</span>

<span class="nb">map</span> <span class="o">=</span> <span class="n">load_map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">Location</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">LOCATION</span><span class="p">))</span>
<span class="n">map_query</span> <span class="o">=</span> <span class="n">MapQuery</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="2.-Define-Helper-Functions-for-Querying,-Building,-and-Placing-Traffic-Signs-">2. Define Helper Functions for Querying, Building, and Placing Traffic Signs <a class="anchor" id="helper_functions"></a><a class="anchor-link" href="#2.-Define-Helper-Functions-for-Querying,-Building,-and-Placing-Traffic-Signs-">¶</a></h2><p>We'll need to be able to query for necessary assets to build our signs with, then develop some logic using map and ego pose information to place them in desirable locations.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Asset-Querying-Functions-">Asset Querying Functions <a class="anchor" id="functions_asset_query"></a><a class="anchor-link" href="#Asset-Querying-Functions-">¶</a></h3><p>Here we define two functions which query the asset registry which will help us get our desired sign and sign post assets, respectively.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_all_country_signs_with_dimensions</span><span class="p">(</span><span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""This function takes the name of a country and returns all sign assets for that country"""</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"sign_name"</span><span class="p">),</span>
            <span class="n">ObjCountries</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"country"</span><span class="p">),</span>
            <span class="n">ObjAssets</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">ObjAssets</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
            <span class="n">ObjAssets</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">UtilSegmentationCategoriesPanoptic</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">panoptic_id</span> <span class="o">==</span> <span class="n">UtilSegmentationCategoriesPanoptic</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DataSign</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">DataSign</span><span class="o">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">ObjAssets</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ObjCountries</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">ObjCountries</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">DataSign</span><span class="o">.</span><span class="n">country_id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ObjAssets</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">ObjAssets</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">asset_id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">UtilSegmentationCategoriesPanoptic</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"TrafficSign"</span><span class="p">,</span>
            <span class="n">ObjCountries</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">country</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>

    <span class="n">sign_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sign</span> <span class="k">for</span> <span class="n">sign</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sign_list</span>


<span class="k">def</span> <span class="nf">get_sign_posts_with_dimensions</span><span class="p">(</span><span class="n">sign_post_list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Returns a list of sign post assets with their dimensions based on list of asset names"""</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ObjAssets</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ObjAssets</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">ObjAssets</span><span class="o">.</span><span class="n">length</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ObjAssets</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">InfoSegmentation</span><span class="o">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">ObjAssets</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ObjAssets</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="n">sign_post_list</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>

    <span class="n">post_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">post</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">query</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">post_list</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Helper-Functions-for-Sign-Generator-">Helper Functions for Sign Generator <a class="anchor" id="functions_sign_generator"></a><a class="anchor-link" href="#Helper-Functions-for-Sign-Generator-">¶</a></h3><p>These functions will be used by our custom sign generator. The first enables us to find a point offset from the curb suitable for placing signs. The second will filter a list of lane segments down to the ones which are appropriate for placing signs alongside.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_offset_point_3d</span><span class="p">(</span>
    <span class="n">point_a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">point_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">left_edge</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">curb_offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">walk_distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Helper function to get a point offset from curb"""</span>
    <span class="n">v_a_b</span> <span class="o">=</span> <span class="n">point_b</span> <span class="o">-</span> <span class="n">point_a</span>
    <span class="n">v_hat_a_b</span> <span class="o">=</span> <span class="n">v_a_b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_a_b</span><span class="p">)</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">point_a</span> <span class="o">+</span> <span class="n">walk_distance</span> <span class="o">*</span> <span class="n">v_hat_a_b</span>

    <span class="k">if</span> <span class="n">left_edge</span><span class="p">:</span>
        <span class="c1"># Clockwise perpendicular vector</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">v_a_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v_a_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Counterclockwise perpendicular vector</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v_a_b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">v_a_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">n_norm</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">offset_point_3d</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">curb_offset</span> <span class="o">*</span> <span class="n">n_norm</span>

    <span class="k">return</span> <span class="n">offset_point_3d</span>


<span class="k">def</span> <span class="nf">get_valid_lane_ids</span><span class="p">(</span><span class="n">lane_segments</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Helper function to get "drivable" lane id's. Aka not parking spaces"""</span>
    <span class="n">valid_lane_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">lane_segments</span><span class="p">:</span>
        <span class="n">lane_dict</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_lane_segment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lane_id</span><span class="p">))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lane_dict</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"DRIVABLE"</span><span class="p">,</span> <span class="s2">"PARKING"</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">"user_data"</span> <span class="ow">in</span> <span class="n">lane_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">"parking_space_angle"</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">lane_dict</span><span class="p">[</span><span class="s2">"user_data"</span><span class="p">]):</span>
                <span class="k">continue</span>
        <span class="n">valid_lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_lane_ids</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="3.-Define-Custom-Simulation-Behaviours-for-Traffic-Signs-and-Poles-">3. Define Custom Simulation Behaviours for Traffic Signs and Poles <a class="anchor" id="custom_behaviours"></a><a class="anchor-link" href="#3.-Define-Custom-Simulation-Behaviours-for-Traffic-Signs-and-Poles-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Traffic-Sign-Behaviour-">Traffic Sign Behaviour <a class="anchor" id="traffic_sign_behaviour"></a><a class="anchor-link" href="#Traffic-Sign-Behaviour-">¶</a></h3><p>This takes care of orienting the sign on the pole properly with respect to the surface normal vector provided by the user, taking the width of the sign post into account.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TrafficSignBehaviour</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">location_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">height_on_pole</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">pole_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">v_hat_sign</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_location_xyz</span> <span class="o">=</span> <span class="n">location_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_v_hat_sign</span> <span class="o">=</span> <span class="n">v_hat_sign</span>  <span class="c1"># This represents the desired surface normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_height_on_pole</span> <span class="o">=</span> <span class="n">height_on_pole</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pole_width</span> <span class="o">=</span> <span class="n">pole_width</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
        <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Calculate offset transformation to orient sign properly on pole</span>
        <span class="n">sign_pos_above_ground_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_location_xyz</span> <span class="o">+</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">up</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_height_on_pole</span>
        <span class="n">offset_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pole_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">final_sign_pos_world_coords</span> <span class="o">=</span> <span class="n">sign_pos_above_ground_xyz</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_hat_sign</span> <span class="o">*</span> <span class="n">offset_m</span>

        <span class="c1"># Get rotation around Z from desired surface normal vector</span>
        <span class="n">z_rot_radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_v_hat_sign</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v_hat_sign</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sign_quat</span> <span class="o">=</span> <span class="n">Transformation</span><span class="o">.</span><span class="n">from_euler_angles</span><span class="p">(</span>
            <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z_rot_radians</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">"xyz"</span>
        <span class="p">)</span><span class="o">.</span><span class="n">quaternion</span>

        <span class="n">sign_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span><span class="n">quaternion</span><span class="o">=</span><span class="n">sign_quat</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">final_sign_pos_world_coords</span><span class="p">)</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">sign_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
        <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
        <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TrafficSignBehaviour"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrafficSignBehaviour</span><span class="p">(</span>
            <span class="n">location_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_location_xyz</span><span class="p">,</span>
            <span class="n">v_hat_sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_v_hat_sign</span><span class="p">,</span>
            <span class="n">pole_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pole_width</span><span class="p">,</span>
            <span class="n">height_on_pole</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_height_on_pole</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Traffic-Pole-Behaviour-">Traffic Pole Behaviour <a class="anchor" id="traffic_pole_behaviour"></a><a class="anchor-link" href="#Traffic-Pole-Behaviour-">¶</a></h3><p>For our traffic pole behaviour, we will make use of the <code>Raycast</code> object, which allows us to find a surface by casting a ray along a vector from a given origin. In this case, we'll pick an origin 10m above the chosen map location for pole placement, then shoot the ray back at the ground so that we can get a precise placement of the pole, allowing us to make accurate assessments of the space available on the pole for placing signs.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TrafficPoleBehaviour</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgentBehaviour</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">pose</span>

    <span class="k">def</span> <span class="nf">set_initial_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
        <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ray_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">translation</span> <span class="o">+</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">up</span> <span class="o">*</span> <span class="mi">10</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">raycast</span><span class="p">(</span>  <span class="c1"># send one ray, but possible to send multiple to cover wider area</span>
                <span class="p">[</span>
                    <span class="n">Raycast</span><span class="p">(</span>
                        <span class="n">origin</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ray_start</span><span class="p">),</span>
                        <span class="n">direction</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">down</span><span class="p">),</span>
                        <span class="n">max_distance</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">final_pose</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span>
            <span class="n">quaternion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">quaternion</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
        <span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">set_pose</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">final_pose</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span>
        <span class="n">agent</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">,</span>
        <span class="n">raycast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TrafficPoleBehaviour"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TrafficPoleBehaviour</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="4.-Create-Traffic-Sign-Generator-">4. Create Traffic Sign Generator <a class="anchor" id="traffic_sign_generator"></a><a class="anchor-link" href="#4.-Create-Traffic-Sign-Generator-">¶</a></h2><p>This generator will procedurally place signs along all the appropriate road segments within a given range of the ego. We do this by querying the map, finding the left and right edges of the road as well as their direction of travel, then use this information to choose xyz positions and surface normals for placing our signs. We pass a list of countries and associated weights to guide random choice of sign assets, then set parameters affecting the number of signs per pole, the spacing between signs, distance away from curb and ground, and the density of pole placement.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MySignGenerator</span><span class="p">(</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomAtomicGenerator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">countries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">density</span><span class="p">:</span> <span class="n">Distribution</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sign_spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">min_sign_distance_to_ground</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">min_signs_per_pole</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">max_signs_per_pole</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">curb_offset_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
        <span class="n">curb_offset_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">placement_radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">countries</span> <span class="o">=</span> <span class="n">countries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span> <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span><span class="p">]</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">999999</span><span class="p">)</span> <span class="k">if</span> <span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signs_per_pole</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_signs_per_pole</span><span class="p">,</span> <span class="n">max_signs_per_pole</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curb_offset</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="n">curb_offset_min</span><span class="p">,</span> <span class="n">curb_offset_max</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign_spacing</span> <span class="o">=</span> <span class="n">sign_spacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_sign_distance_to_ground</span> <span class="o">=</span> <span class="n">min_sign_distance_to_ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">placement_radius</span> <span class="o">=</span> <span class="n">placement_radius</span>
        <span class="c1"># Here we use a pre-selected set of useful sign post assets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign_posts</span> <span class="o">=</span> <span class="n">get_sign_posts_with_dimensions</span><span class="p">(</span>
            <span class="n">sign_post_list</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">"post_round_metal_0365h_06r"</span><span class="p">,</span>
                <span class="s2">"post_sign_0288h02r"</span><span class="p">,</span>
                <span class="s2">"crosswalkpost_01_small"</span><span class="p">,</span>
                <span class="s2">"post_round_metal_0400h_08r"</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign_post_select</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_posts</span><span class="p">))))</span>
        <span class="c1"># Query the database to grab all signs for each specified country, along with dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_signs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">country</span><span class="p">:</span> <span class="n">get_all_country_signs_with_dimensions</span><span class="p">(</span><span class="n">country</span><span class="p">)</span> <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countries</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_sign_select</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">country</span><span class="p">:</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">country_signs</span><span class="p">[</span><span class="n">country</span><span class="p">]))))</span>
            <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_signs</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_select</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country_select</span><span class="o">.</span><span class="n">set_categorial_choices</span><span class="p">(</span>
            <span class="n">choices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">countries</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">countries</span><span class="p">]</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">weights</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Increments seed each time we reference it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span>

    <span class="k">def</span> <span class="nf">create_agents_for_new_scene</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">ExtendedSimState</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">]:</span>

        <span class="n">road_segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_road_segments_near_ego</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">ego_pose</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">placement_radius</span><span class="p">)</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">road_segments</span><span class="p">:</span>
            <span class="c1"># Valid lane ids are lanes that are not parking spaces.</span>
            <span class="c1"># We can't use parking space edges as left or right edges</span>
            <span class="n">valid_lane_ids</span> <span class="o">=</span> <span class="n">get_valid_lane_ids</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">"lane_segments"</span><span class="p">])</span>

            <span class="c1"># Fix this to perform sign placing for all roads</span>
            <span class="n">left_lane_id</span> <span class="o">=</span> <span class="n">valid_lane_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">right_lane_id</span> <span class="o">=</span> <span class="n">valid_lane_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">left_lane</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_lane_segment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">left_lane_id</span><span class="p">))</span>
            <span class="n">right_lane</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_lane_segment</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">right_lane_id</span><span class="p">))</span>

            <span class="c1"># This is needed if placing signs so that they face the direction of travel</span>
            <span class="n">left_lane_forward_direction</span> <span class="o">=</span> <span class="n">left_lane</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">"direction"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"FORWARD"</span>
            <span class="n">right_lane_forward_direction</span> <span class="o">=</span> <span class="n">right_lane</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">"direction"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"FORWARD"</span>

            <span class="c1"># This logic ensures we are finding the correct (outside) edges of the road</span>
            <span class="n">left_lane_left_edge_id</span> <span class="o">=</span> <span class="n">left_lane</span><span class="o">.</span><span class="n">left_edge</span> <span class="k">if</span> <span class="n">left_lane_forward_direction</span> <span class="k">else</span> <span class="n">left_lane</span><span class="o">.</span><span class="n">right_edge</span>
            <span class="n">right_lane_right_edge_id</span> <span class="o">=</span> <span class="n">right_lane</span><span class="o">.</span><span class="n">right_edge</span> <span class="k">if</span> <span class="n">right_lane_forward_direction</span> <span class="k">else</span> <span class="n">right_lane</span><span class="o">.</span><span class="n">left_edge</span>

            <span class="n">left_lane_left_edge</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">left_lane_left_edge_id</span><span class="p">))</span>
            <span class="n">right_lane_right_edge</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">right_lane_right_edge_id</span><span class="p">))</span>

            <span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_signs_along_edge</span><span class="p">(</span>
                <span class="n">e</span><span class="o">=</span><span class="n">left_lane_left_edge</span><span class="p">,</span>
                <span class="n">left_edge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">is_forward_lane</span><span class="o">=</span><span class="n">left_lane_forward_direction</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_signs_along_edge</span><span class="p">(</span>
                <span class="n">e</span><span class="o">=</span><span class="n">right_lane_right_edge</span><span class="p">,</span>
                <span class="n">left_edge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">is_forward_lane</span><span class="o">=</span><span class="n">right_lane_forward_direction</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">agents</span>

    <span class="k">def</span> <span class="nf">get_valid_road_segments_near_ego</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ego_pose</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LaneSegment</span><span class="p">]:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">BoundingBox2DBaseGeometry</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">ego_pose</span><span class="o">.</span><span class="n">translation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">road_segments</span> <span class="o">=</span> <span class="n">map_query</span><span class="o">.</span><span class="n">get_road_segments_within_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">"overlap"</span><span class="p">)</span>
        <span class="c1"># Here we exclude some road types we won't want to place signs beside (like driveways)</span>
        <span class="n">road_segments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">seg</span>
            <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">road_segments</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"type"</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">seg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">"type"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"UNCLASSIFIED"</span><span class="p">,</span> <span class="s2">"DRIVEWAY"</span><span class="p">,</span> <span class="s2">"MOTORWAY"</span><span class="p">,</span> <span class="s2">"PARKING_AISLE"</span><span class="p">,</span> <span class="s2">"DRIVEWAY_PARKING_ENTRY"</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">road_segments</span>

    <span class="k">def</span> <span class="nf">place_signs_along_edge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">left_edge</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">is_forward_lane</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">]:</span>
        <span class="n">sign_agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edge_dict</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Random distance to walk along edge before placing first sign</span>
        <span class="n">remaining_walk_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_dict</span><span class="p">[</span><span class="s2">"points"</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">point_a_dict</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s2">"points"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">point_b_dict</span> <span class="o">=</span> <span class="n">edge_dict</span><span class="p">[</span><span class="s2">"points"</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get unit vector in same direction as segment a -&gt; b of edge</span>
            <span class="n">point_a_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point_a_dict</span><span class="p">[</span><span class="s2">"x"</span><span class="p">],</span> <span class="n">point_a_dict</span><span class="p">[</span><span class="s2">"y"</span><span class="p">],</span> <span class="n">point_a_dict</span><span class="p">[</span><span class="s2">"z"</span><span class="p">]])</span>
            <span class="n">point_b_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point_b_dict</span><span class="p">[</span><span class="s2">"x"</span><span class="p">],</span> <span class="n">point_b_dict</span><span class="p">[</span><span class="s2">"y"</span><span class="p">],</span> <span class="n">point_b_dict</span><span class="p">[</span><span class="s2">"z"</span><span class="p">]])</span>
            <span class="n">v_a_b</span> <span class="o">=</span> <span class="n">point_b_3d</span> <span class="o">-</span> <span class="n">point_a_3d</span>
            <span class="n">len_a_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_a_b</span><span class="p">)</span>
            <span class="n">v_hat_a_b</span> <span class="o">=</span> <span class="n">v_a_b</span> <span class="o">/</span> <span class="n">len_a_b</span>

            <span class="c1"># Needed to determine which way sign should face</span>
            <span class="n">offset_direction</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_forward_lane</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">v_hat_sign</span> <span class="o">=</span> <span class="n">offset_direction</span> <span class="o">*</span> <span class="n">v_hat_a_b</span>

            <span class="c1"># This tracks how far we have already travelled on segment a -&gt; b.</span>
            <span class="n">already_walked_in_segment</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">already_walked_in_segment</span> <span class="o">+</span> <span class="n">remaining_walk_distance</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len_a_b</span><span class="p">:</span>
                <span class="c1"># Get point 'away' from the road, so that pole is placed on sidewalk/shoulder</span>
                <span class="n">offset_point_3d</span> <span class="o">=</span> <span class="n">get_offset_point_3d</span><span class="p">(</span>
                    <span class="n">point_a_3d</span><span class="p">,</span>
                    <span class="n">point_b_3d</span><span class="p">,</span>
                    <span class="n">left_edge</span><span class="o">=</span><span class="n">left_edge</span><span class="p">,</span>
                    <span class="n">curb_offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curb_offset</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">),</span>
                    <span class="n">walk_distance</span><span class="o">=</span><span class="n">already_walked_in_segment</span> <span class="o">+</span> <span class="n">remaining_walk_distance</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">offset_point_trans</span> <span class="o">=</span> <span class="n">Transformation</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">offset_point_3d</span><span class="p">)</span>

                <span class="n">sign_agents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">construct_pole_with_signs</span><span class="p">(</span><span class="n">offset_point_trans</span><span class="p">,</span> <span class="n">v_hat_sign</span><span class="p">))</span>

                <span class="n">already_walked_in_segment</span> <span class="o">+=</span> <span class="n">remaining_walk_distance</span>
                <span class="c1"># Now that sign is placed, get new random distance to next sign</span>
                <span class="n">remaining_walk_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

            <span class="n">remaining_walk_distance</span> <span class="o">-=</span> <span class="p">(</span><span class="n">len_a_b</span> <span class="o">-</span> <span class="n">already_walked_in_segment</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sign_agents</span>

    <span class="k">def</span> <span class="nf">construct_pole_with_signs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xyz_world</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">v_hat_sign</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Builds a list of agents comprising a sign pole populated with a random number of signs"""</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pole_to_place</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_posts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sign_post_select</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)]</span>
        <span class="n">pole_name</span> <span class="o">=</span> <span class="n">pole_to_place</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
        <span class="n">pole_agent</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
            <span class="n">asset_name</span><span class="o">=</span><span class="n">pole_name</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span><span class="n">TrafficPoleBehaviour</span><span class="p">(</span><span class="n">pose</span><span class="o">=</span><span class="n">xyz_world</span><span class="p">))</span>

        <span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pole_agent</span><span class="p">)</span>
        <span class="n">agents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populate_signs_on_pole</span><span class="p">(</span><span class="n">pole_to_place</span><span class="o">=</span><span class="n">pole_to_place</span><span class="p">,</span> <span class="n">xyz_world</span><span class="o">=</span><span class="n">xyz_world</span><span class="p">,</span> <span class="n">v_hat_sign</span><span class="o">=</span><span class="n">v_hat_sign</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">agents</span>

    <span class="k">def</span> <span class="nf">populate_signs_on_pole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pole_to_place</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">xyz_world</span><span class="p">:</span> <span class="n">Transformation</span><span class="p">,</span> <span class="n">v_hat_sign</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Takes a sign pole agent and adds a number of signs that face the provided surface normal"""</span>
        <span class="n">sign_agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">country_to_place_sign_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_select</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="c1"># Place random number of signs on pole, but only if there is enough room</span>
        <span class="n">highest_unoccupied_point_on_pole</span> <span class="o">=</span> <span class="n">pole_to_place</span><span class="p">[</span><span class="s2">"height"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signs_per_pole</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)):</span>
            <span class="c1"># Grab random sign from selected country</span>
            <span class="n">signs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_signs</span><span class="p">[</span><span class="n">country_to_place_sign_from</span><span class="p">]</span>
            <span class="n">selection_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_sign_select</span><span class="p">[</span><span class="n">country_to_place_sign_from</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
            <span class="n">sign_to_place</span> <span class="o">=</span> <span class="n">signs</span><span class="p">[</span><span class="n">selection_index</span><span class="p">]</span>
            <span class="n">sign_name</span> <span class="o">=</span> <span class="n">sign_to_place</span><span class="p">[</span><span class="s2">"sign_name"</span><span class="p">]</span>

            <span class="c1"># Ensuring we have enough space to place sign</span>
            <span class="n">remaining_pole_space</span> <span class="o">=</span> <span class="n">highest_unoccupied_point_on_pole</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sign_distance_to_ground</span>
            <span class="k">if</span> <span class="n">sign_to_place</span><span class="p">[</span><span class="s2">"height"</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_spacing</span> <span class="o">&lt;</span> <span class="n">remaining_pole_space</span><span class="p">:</span>
                <span class="c1"># Place sign. Exact placement of sign on pole is handled inside traffic sign behaviour class.</span>
                <span class="n">sign_height_on_pole</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">highest_unoccupied_point_on_pole</span>
                    <span class="o">-</span> <span class="p">(</span><span class="n">sign_to_place</span><span class="p">[</span><span class="s2">"height"</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_spacing</span>
                <span class="p">)</span>
                <span class="n">sign_agent</span> <span class="o">=</span> <span class="n">data_lab</span><span class="o">.</span><span class="n">CustomSimulationAgents</span><span class="o">.</span><span class="n">create_object</span><span class="p">(</span>
                    <span class="n">asset_name</span><span class="o">=</span><span class="n">sign_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">set_behaviour</span><span class="p">(</span>
                    <span class="n">TrafficSignBehaviour</span><span class="p">(</span>
                        <span class="n">location_xyz</span><span class="o">=</span><span class="n">xyz_world</span><span class="o">.</span><span class="n">translation</span><span class="p">,</span>
                        <span class="n">height_on_pole</span><span class="o">=</span><span class="n">sign_height_on_pole</span><span class="p">,</span>
                        <span class="n">pole_width</span><span class="o">=</span><span class="n">pole_to_place</span><span class="p">[</span><span class="s2">"width"</span><span class="p">],</span>
                        <span class="n">v_hat_sign</span><span class="o">=</span><span class="n">v_hat_sign</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">highest_unoccupied_point_on_pole</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sign_to_place</span><span class="p">[</span><span class="s2">"height"</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_spacing</span><span class="p">)</span>
                <span class="n">sign_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign_agent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sign_agents</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MySignGenerator</span><span class="p">(</span>
            <span class="n">countries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">countries</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="5.-Create-Scenario-">5. Create Scenario <a class="anchor" id="scenario_gen"></a><a class="anchor-link" href="#5.-Create-Scenario-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Build-Base-Scenario-">Build Base Scenario <a class="anchor" id="scenario_init"></a><a class="anchor-link" href="#Build-Base-Scenario-">¶</a></h3><p>We can use our helper function to generate a base scenario.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [41]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">202</span>
<span class="n">scenario</span> <span class="o">=</span> <span class="n">build_demo_scenario</span><span class="p">(</span><span class="n">location_name</span><span class="o">=</span><span class="n">LOCATION</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">min_pedestrians</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Using random seed 202 on SF_GrantAndCalifornia
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<p><em>Example of scene without signs added</em>
<img alt="Empty scene" src="./resources/images/road_signs_empty.jpg"/></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Add-sign-agents-to-the-scene-using-custom-sign-generator-">Add sign agents to the scene using custom sign generator <a class="anchor" id="scenario_add_signs"></a><a class="anchor-link" href="#Add-sign-agents-to-the-scene-using-custom-sign-generator-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [38]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sign_generator</span> <span class="o">=</span> <span class="n">MySignGenerator</span><span class="p">(</span><span class="n">countries</span><span class="o">=</span><span class="p">[</span><span class="s2">"Greece"</span><span class="p">,</span> <span class="s2">"Turkey"</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="n">sign_generator</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">set_uniform_distribution</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">add_agents</span><span class="p">(</span><span class="n">sign_generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[38]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;pd.data_lab.scenario.Scenario at 0x2265b34c3a0&gt;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Preview-scenario-with-signs-added-">Preview scenario with signs added <a class="anchor" id="scenario_preview_signs"></a><a class="anchor-link" href="#Preview-scenario-with-signs-added-">¶</a></h3><p>Include semantic segmentation as an output annotation</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [26]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">preview_scenario</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">annotations_to_show</span><span class="o">=</span><span class="p">[</span><span class="n">SemanticSegmentation2D</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[26]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div data-rrd="1" id="USXsmw_rrd" style="display: none;"></div>
<div id="USXsmw_error" style="display: none;"><p>Timed out waiting for https://app.rerun.io/commit/df05f49 to load.</p>
<p>Consider using <code>rr.start_web_viewer_server()</code></p></div>
<script>
            USXsmw_timeout = setTimeout(() => {
                document.getElementById("USXsmw_error").style.display = 'block';
            }, 2000);

            window.addEventListener("message", function(rrd) {
                return async function USXsmw_onIframeReady(event) {
                    var iframe = document.getElementById("USXsmw_iframe");
                    if (event.source === iframe.contentWindow) {
                        clearTimeout(USXsmw_timeout);
                        document.getElementById("USXsmw_error").style.display = 'none';
                        iframe.style.display = 'inline';
                        window.removeEventListener("message", USXsmw_onIframeReady);
                        iframe.contentWindow.postMessage((await rrd), "*");
                    }
                }
            }(async function() {
                await new Promise(r => setTimeout(r, 0));
                var div = document.getElementById("USXsmw_rrd");
                var base64Data = div.dataset.rrd;
                var intermediate = atob(base64Data);
                var buff = new Uint8Array(intermediate.length);
                for (var i = 0; i < intermediate.length; i++) {
                    buff[i] = intermediate.charCodeAt(i);
                }
                return buff;
            }()));
        </script>
<iframe allowfullscreen="" frameborder="0" height="712" id="USXsmw_iframe" src="https://app.rerun.io/commit/df05f49?url=web_event://&amp;persist=0" style="display: none;" width="950"></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="6.-Create-a-Mini-Batch-">6. Create a Mini Batch <a class="anchor" id="mini_batch"></a><a class="anchor-link" href="#6.-Create-a-Mini-Batch-">¶</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Render-Mini-Batch-and-Save-to-Disk-">Render Mini Batch and Save to Disk <a class="anchor" id="mini_batch_save"></a><a class="anchor-link" href="#Render-Mini-Batch-and-Save-to-Disk-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [42]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">OUTPUT_DATASET_PATH</span> <span class="o">=</span> <span class="s2">"./road_signs_output"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [43]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_lab</span><span class="o">.</span><span class="n">create_mini_batch</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
    <span class="n">frames_per_scene</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">number_of_scenes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sim_capture_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">start_skip_frames</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">sim_instance</span><span class="o">=</span><span class="n">SimulationInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">render_instance</span><span class="o">=</span><span class="n">RenderInstance</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">INSTANCE_NAME</span><span class="p">),</span>
    <span class="n">format_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset_output_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">,</span>
        <span class="n">encode_to_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">pipeline_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">copy_all_available_sensors_and_annotations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_env</span><span class="o">=</span><span class="s2">"thread"</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 0 sensor frames [00:00, ? sensor frames/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre><span class="ansi-green-fg">2023-08-14 16:23:29</span> <span class="ansi-blue-fg">paralleldomain.encoding.stream_pipeline_builder[build_pipeline_source_generator]</span> <span class="ansi-black-intense-fg ansi-bold">INFO</span> Encoding Scene Step Stream
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>Encoding Progress: 3 sensor frames [01:37, 32.49s/ sensor frames]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="Load-Mini-Batch-with-PD-SDK-">Load Mini Batch with PD-SDK <a class="anchor" id="mini_batch_load"></a><a class="anchor-link" href="#Load-Mini-Batch-with-PD-SDK-">¶</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [46]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">DGPDatasetDecoder</span><span class="p">(</span><span class="n">dataset_path</span><span class="o">=</span><span class="n">OUTPUT_DATASET_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_scene</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">scene_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>
